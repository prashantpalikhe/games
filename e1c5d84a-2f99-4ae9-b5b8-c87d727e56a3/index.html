<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Secure Link - No Server</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PeerJS for WebRTC handling (Public Signaling) -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom scrollbar for chat */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        video {
            transform: scaleX(-1); /* Mirror effect */
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col overflow-hidden font-sans">

    <!-- Header -->
    <header class="bg-gray-800 p-4 flex justify-between items-center shadow-md z-10">
        <div class="flex items-center gap-2">
            <i data-lucide="zap" class="text-yellow-400"></i>
            <h1 class="font-bold text-lg tracking-wide">SyncLink <span class="text-xs text-gray-400 font-normal">P2P Secured</span></h1>
        </div>
        <div id="status-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span>
            Initializing...
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row relative overflow-hidden">
        
        <!-- Video Section -->
        <div class="relative flex-1 bg-black flex items-center justify-center group">
            
            <!-- Remote Video (Full Screen) -->
            <video id="remote-video" autoplay playsinline class="w-full h-full object-cover"></video>
            
            <!-- Placeholder when no video -->
            <div id="video-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 bg-gray-900 z-0">
                <i data-lucide="video-off" class="w-16 h-16 mb-4 opacity-50"></i>
                <p class="text-sm">Waiting for video stream...</p>
            </div>

            <!-- Local Video (Floating Picture-in-Picture) -->
            <div class="absolute top-4 right-4 w-32 md:w-48 aspect-video bg-gray-800 rounded-lg overflow-hidden shadow-2xl border border-gray-700 z-10">
                <video id="local-video" autoplay playsinline muted class="w-full h-full object-cover"></video>
            </div>

            <!-- Controls Overlay -->
            <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex gap-4 p-3 bg-gray-900/80 backdrop-blur-md rounded-2xl border border-gray-700/50 opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-20">
                <button id="btn-toggle-mic" class="p-3 rounded-full bg-gray-700 hover:bg-gray-600 transition text-white" title="Toggle Microphone">
                    <i data-lucide="mic"></i>
                </button>
                <button id="btn-toggle-video" class="p-3 rounded-full bg-gray-700 hover:bg-gray-600 transition text-white" title="Toggle Camera">
                    <i data-lucide="video"></i>
                </button>
                <button onclick="window.location.href=window.location.pathname" class="p-3 rounded-full bg-red-500 hover:bg-red-600 transition text-white" title="End Call">
                    <i data-lucide="phone-off"></i>
                </button>
            </div>

            <!-- Invite Overlay (Only visible when not connected) -->
            <div id="invite-overlay" class="absolute inset-0 bg-black/80 backdrop-blur-sm z-30 flex flex-col items-center justify-center p-6 text-center hidden">
                <div class="bg-gray-800 p-8 rounded-2xl border border-gray-700 max-w-md w-full shadow-2xl">
                    <div class="w-16 h-16 bg-blue-500/20 text-blue-400 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i data-lucide="link" class="w-8 h-8"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">Invite a Peer</h2>
                    <p class="text-gray-400 mb-6">Share this unique link to start a secure P2P video chat.</p>
                    
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="invite-link" readonly class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-sm text-gray-300 focus:outline-none focus:border-blue-500 select-all">
                        <button id="btn-copy" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium transition flex items-center gap-2">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500">Data flows directly between devices. No server storage.</p>
                </div>
            </div>
        </div>

        <!-- Chat Section (Collapsible on mobile) -->
        <div class="w-full md:w-80 bg-gray-800 border-l border-gray-700 flex flex-col h-1/3 md:h-auto">
            <div class="p-4 border-b border-gray-700 bg-gray-800/50 backdrop-blur">
                <h3 class="font-semibold flex items-center gap-2">
                    <i data-lucide="message-square" class="w-4 h-4 text-blue-400"></i> Chat
                </h3>
            </div>
            
            <!-- Messages Area -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-hide bg-gray-900/30">
                <div class="text-center text-xs text-gray-500 mt-4">
                    Messages are encrypted and P2P.<br>Nothing is saved.
                </div>
            </div>

            <!-- Input Area -->
            <form id="chat-form" class="p-3 bg-gray-800 border-t border-gray-700 flex gap-2">
                <input type="text" id="chat-input" placeholder="Type a message..." class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-sm text-white focus:outline-none focus:border-blue-500">
                <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white p-2 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </form>
        </div>

    </main>

    <script>
        // --- Config & State ---
        // We use PeerJS default public cloud server for signaling. 
        // It acts as a broker to find the other person, then drops out.
        let peer = null;
        let conn = null; // Data connection (Chat)
        let call = null; // Media connection (Video)
        let localStream = null;
        let myPeerId = null;
        
        // Check if we are the Guest (User B) trying to connect to a Host (User A)
        const urlParams = new URLSearchParams(window.location.search);
        const remotePeerId = urlParams.get('connect');
        const isHost = !remotePeerId;

        // --- UI Elements ---
        const statusBadge = document.getElementById('status-badge');
        const inviteOverlay = document.getElementById('invite-overlay');
        const inviteLinkInput = document.getElementById('invite-link');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const videoPlaceholder = document.getElementById('video-placeholder');

        // --- Icons Init ---
        lucide.createIcons();

        // --- Main Initialization ---
        async function init() {
            try {
                // 1. Get Local Stream (Camera/Mic)
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
            } catch (err) {
                console.error("Failed to get local stream", err);
                addMessage('System', 'Error accessing camera/microphone. Ensure permissions are granted.', 'error');
            }

            // 2. Initialize Peer
            peer = new Peer();

            peer.on('open', (id) => {
                myPeerId = id;
                console.log('My ID:', id);

                if (isHost) {
                    // HOST MODE
                    updateStatus('Waiting for Peer', 'yellow');
                    showInviteScreen(id);
                    
                    // Listen for incoming connections
                    peer.on('connection', (connection) => {
                        handleDataConnection(connection);
                    });
                    
                    peer.on('call', (incomingCall) => {
                        handleCall(incomingCall);
                    });
                } else {
                    // GUEST MODE
                    updateStatus('Connecting to Host...', 'blue');
                    connectToHost(remotePeerId);
                }
            });

            peer.on('error', (err) => {
                console.error(err);
                updateStatus('Connection Error', 'red');
                addMessage('System', 'Connection error: ' + err.type, 'error');
            });
        }

        // --- Host Logic ---
        function showInviteScreen(id) {
            inviteOverlay.classList.remove('hidden');
            const link = `${window.location.protocol}//${window.location.host}${window.location.pathname}?connect=${id}`;
            inviteLinkInput.value = link;
        }

        // --- Guest Logic ---
        function connectToHost(hostId) {
            // 1. Open Data Connection (Chat)
            const connection = peer.connect(hostId);
            handleDataConnection(connection);

            // 2. Call (Video)
            const outgoingCall = peer.call(hostId, localStream);
            handleCall(outgoingCall);
        }

        // --- Handlers ---

        function handleDataConnection(connection) {
            conn = connection;
            
            conn.on('open', () => {
                updateStatus('Connected Securely', 'green');
                inviteOverlay.classList.add('hidden');
                addMessage('System', 'Peer connected via P2P channel.', 'system');
            });

            conn.on('data', (data) => {
                if (data.type === 'chat') {
                    addMessage('Peer', data.message, 'received');
                }
            });

            conn.on('close', () => {
                updateStatus('Peer Disconnected', 'red');
                addMessage('System', 'Peer disconnected.', 'error');
                // Handle remote video cleanup if needed
                remoteVideo.srcObject = null;
                videoPlaceholder.style.zIndex = "0"; 
            });
        }

        function handleCall(currentCall) {
            call = currentCall;
            
            // Answer the call if we receive one (Host side logic mainly, but good for both)
            // If we initiated the call, this 'call' object is already the one we need.
            // However, peerJS `peer.on('call')` gives us a call we must answer.
            
            if (isHost) {
                // We answer incoming call
                call.answer(localStream); 
            }

            // Stream handler
            call.on('stream', (remoteStream) => {
                remoteVideo.srcObject = remoteStream;
                videoPlaceholder.style.zIndex = "-1"; // Hide placeholder
            });

            call.on('close', () => {
                remoteVideo.srcObject = null;
                videoPlaceholder.style.zIndex = "0";
            });
        }

        // --- Chat Functions ---
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const msg = chatInput.value.trim();
            if (!msg) return;

            if (conn && conn.open) {
                conn.send({ type: 'chat', message: msg });
                addMessage('You', msg, 'sent');
                chatInput.value = '';
            } else {
                addMessage('System', 'Not connected to a peer yet.', 'error');
            }
        });

        function addMessage(sender, text, type) {
            const div = document.createElement('div');
            
            let classes = "max-w-[85%] rounded-lg p-3 text-sm break-words animate-fade-in ";
            let align = "self-start"; // Default left

            if (type === 'sent') {
                classes += "bg-blue-600 text-white";
                align = "self-end";
            } else if (type === 'received') {
                classes += "bg-gray-700 text-gray-200";
            } else if (type === 'system') {
                classes += "bg-green-900/30 text-green-400 text-xs w-full text-center border border-green-800/50";
                align = "self-center";
            } else if (type === 'error') {
                classes += "bg-red-900/30 text-red-400 text-xs w-full text-center border border-red-800/50";
                align = "self-center";
            }

            div.className = classes;
            div.textContent = text;

            // Wrapper for alignment
            const wrapper = document.createElement('div');
            wrapper.className = `flex flex-col ${align} w-full`;
            wrapper.appendChild(div);
            
            // Sender label for normal messages
            if (type === 'sent' || type === 'received') {
                const label = document.createElement('span');
                label.className = `text-[10px] text-gray-500 mt-1 ${type === 'sent' ? 'text-right' : 'text-left'}`;
                label.textContent = sender;
                wrapper.appendChild(label);
            }

            chatMessages.appendChild(wrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // --- Utilities ---
        function updateStatus(text, color) {
            let bgClass = '';
            let textClass = '';
            let borderClass = '';
            let dotClass = '';

            if (color === 'green') {
                bgClass = 'bg-green-500/20'; textClass = 'text-green-400'; borderClass = 'border-green-500/30'; dotClass = 'bg-green-400';
            } else if (color === 'yellow') {
                bgClass = 'bg-yellow-500/20'; textClass = 'text-yellow-400'; borderClass = 'border-yellow-500/30'; dotClass = 'bg-yellow-400';
            } else if (color === 'red') {
                bgClass = 'bg-red-500/20'; textClass = 'text-red-400'; borderClass = 'border-red-500/30'; dotClass = 'bg-red-400';
            } else if (color === 'blue') {
                bgClass = 'bg-blue-500/20'; textClass = 'text-blue-400'; borderClass = 'border-blue-500/30'; dotClass = 'bg-blue-400';
            }

            statusBadge.className = `px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2 transition-colors duration-300 ${bgClass} ${textClass} ${borderClass}`;
            statusBadge.innerHTML = `<span class="w-2 h-2 rounded-full ${dotClass} ${color === 'yellow' || color === 'blue' ? 'animate-pulse' : ''}"></span>${text}`;
        }

        // Copy Button
        document.getElementById('btn-copy').addEventListener('click', () => {
            inviteLinkInput.select();
            document.execCommand('copy');
            const btn = document.getElementById('btn-copy');
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i>`;
            btn.classList.remove('bg-blue-600');
            btn.classList.add('bg-green-600');
            setTimeout(() => {
                btn.innerHTML = originalContent;
                btn.classList.add('bg-blue-600');
                btn.classList.remove('bg-green-600');
                lucide.createIcons();
            }, 2000);
        });

        // Media Controls
        let isAudioEnabled = true;
        let isVideoEnabled = true;

        document.getElementById('btn-toggle-mic').addEventListener('click', function() {
            isAudioEnabled = !isAudioEnabled;
            localStream.getAudioTracks()[0].enabled = isAudioEnabled;
            this.innerHTML = isAudioEnabled ? '<i data-lucide="mic"></i>' : '<i data-lucide="mic-off" class="text-red-400"></i>';
            this.classList.toggle('bg-red-900/50', !isAudioEnabled);
            lucide.createIcons();
        });

        document.getElementById('btn-toggle-video').addEventListener('click', function() {
            isVideoEnabled = !isVideoEnabled;
            localStream.getVideoTracks()[0].enabled = isVideoEnabled;
            this.innerHTML = isVideoEnabled ? '<i data-lucide="video"></i>' : '<i data-lucide="video-off" class="text-red-400"></i>';
            this.classList.toggle('bg-red-900/50', !isVideoEnabled);
            lucide.createIcons();
        });

        // Start
        init();

    </script>
</body>
</html>