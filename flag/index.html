<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- iOS / PWA Setup -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Flag Master">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="icon" type="image/png" href="/flag/icon.png">
    <link rel="apple-touch-icon" href="/flag/icon.png">

    <!-- Google Fonts: Nunito -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <title>Flag Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nunito', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'bounce-custom-small': 'bounce-custom-small 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'fade-in': 'fade-in 0.3s ease-out forwards'
                    },
                    keyframes: {
                        'bounce-custom-small': {
                            '0%': { transform: 'scale(0.9)', opacity: 0 },
                            '100%': { transform: 'scale(1)', opacity: 1 }
                        },
                        'fade-in': {
                            '0%': { opacity: 0 },
                            '100%': { opacity: 1 }
                        }
                    }
                }
            }
        }
    </script>
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <style>
        /* Force full height and background for iOS status bar area */
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
        }
        
        html {
            height: 100%;
            background-color: #ffffff;
            padding: 0;
            margin: 0;
        }
        
        body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            /* Extend background to status bar */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        /* Custom utilities for animations */
        @keyframes bounce-custom {
            0%, 100% { transform: translateY(-10%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }
        .animate-bounce-custom {
            animation: bounce-custom 1s infinite;
        }
        
        /* Safe area for notch */
        .safe-top {
            padding-top: var(--safe-top);
        }
        
        /* Smooth transitions for the bottom sheet */
        .sheet-transition {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Prevent highlighting text on rapid clicks */
        .no-select {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* Disable touch actions for zoom and bounce */
        html, body {
            touch-action: manipulation;
            overscroll-behavior: none;
        }

        /* Fade transition for screens */
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        /* Animated Background */
        @keyframes gradient-bg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .animate-gradient {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient-bg 15s ease infinite;
        }

        /* Floating Points */
        @keyframes float-up {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-60px) scale(1.2); opacity: 0; }
        }
        .float-points {
            position: absolute;
            font-weight: 900;
            color: #facc15; /* Yellow-400 */
            -webkit-text-stroke: 1px #b45309; /* Amber-700 outline */
            text-shadow: 2px 2px 0px rgba(0,0,0,0.2);
            pointer-events: none;
            animation: float-up 1s ease-out forwards;
            z-index: 100;
            font-size: 2.5rem;
            font-family: system-ui, -apple-system, sans-serif;
        }

        /* Screen Shake */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans overflow-hidden flex justify-center items-center animate-gradient">
    

    <!-- App Container -->
    <div id="app" :class="{'animate-shake': shakeActive}" class="w-full max-w-md h-full max-h-[900px] bg-white shadow-2xl relative overflow-hidden flex flex-col md:rounded-xl md:h-[90vh] md:mt-0 transition-transform">
        
        <!-- Floating Points Container -->
        <div class="absolute inset-0 pointer-events-none overflow-hidden z-50">
            <div 
                v-for="point in floatingPoints" 
                :key="point.id"
                class="float-points"
                :style="{ left: point.x + 'px', top: point.y + 'px' }"
            >
                +{{ point.amount }}
            </div>
        </div>

        <!-- Fireworks Container -->
        <div ref="fireworksContainer" class="absolute inset-0 pointer-events-none z-40"></div>

        <!-- Region Selector Modal -->
        <div v-if="showRegionSelector" class="fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm animate-fade-in">
            <div class="bg-white w-full max-w-md md:rounded-2xl rounded-t-2xl p-6 pb-10 md:pb-6 animate-bounce-custom-small shadow-2xl" @click.stop>
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Select Region</h3>
                    <button @click="showRegionSelector = false" class="text-gray-400 hover:text-gray-600 bg-gray-100 rounded-full p-1" v-html="icons.x"></button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button 
                        v-for="region in continents" 
                        :key="region"
                        @click="selectedRegion = region; showRegionSelector = false"
                        class="py-3 px-4 rounded-xl font-bold text-left transition-all flex justify-between items-center border-2"
                        :class="selectedRegion === region ? 'bg-blue-50 border-blue-500 text-blue-700' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'"
                    >
                        <span>{{ region }}</span>
                        <span v-if="selectedRegion === region" v-html="icons.check" class="text-blue-500 scale-75"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div v-if="showSettings" class="fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm animate-fade-in">
            <div class="bg-white w-full max-w-md md:rounded-2xl rounded-t-2xl p-6 pb-10 md:pb-6 animate-bounce-custom-small shadow-2xl" @click.stop>
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Settings</h3>
                    <button @click="showSettings = false" class="text-gray-400 hover:text-gray-600 bg-gray-100 rounded-full p-1" v-html="icons.x"></button>
                </div>
                <div class="flex flex-col space-y-4">
                    <button 
                        @click="soundEnabled = !soundEnabled"
                        class="py-4 px-4 rounded-xl font-bold text-left transition-all flex justify-between items-center border-2"
                        :class="soundEnabled ? 'bg-blue-50 border-blue-500 text-blue-700' : 'bg-white border-gray-200 text-gray-600'"
                    >
                        <div class="flex items-center space-x-3">
                            <span v-html="soundEnabled ? icons.volume : icons.volumeOff"></span>
                            <span>Sound Effects</span>
                        </div>
                        <div class="w-12 h-6 rounded-full relative transition-colors duration-200" :class="soundEnabled ? 'bg-blue-500' : 'bg-gray-300'">
                            <div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform duration-200" :class="soundEnabled ? 'translate-x-6' : 'translate-x-0'"></div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- START SCREEN -->
        <div v-if="screen === 'start'" class="flex flex-col items-center justify-center h-full p-6 text-center animate-fade-in relative">
            <!-- Settings Button -->
            <button 
                @click="showSettings = true"
                class="absolute right-4 p-2 bg-white border border-gray-200 hover:bg-gray-50 rounded-full text-gray-500 hover:text-gray-700 transition-colors shadow-sm"
                style="top: calc(1rem + env(safe-area-inset-top, 20px));"
            >
                <span v-html="icons.gear"></span>
            </button>

            <div class="mb-8 animate-bounce-custom">
                <div class="w-32 h-24 bg-blue-500 rounded-lg shadow-lg flex items-center justify-center relative overflow-hidden border-4 border-blue-700 transform rotate-3">
                    <div class="absolute inset-0 flex flex-col">
                        <div class="h-1/3 bg-yellow-400"></div>
                        <div class="h-1/3 bg-blue-500"></div>
                        <div class="h-1/3 bg-red-500"></div>
                    </div>
                </div>
            </div>
            <h1 class="text-4xl font-extrabold text-gray-800 mb-4">Flag Master</h1>
            <p class="text-gray-500 text-lg mb-8 max-w-md">
                Master all {{ totalCountries }} flags of the world in one endless run!
            </p>
            
            <div v-if="highScore > 0" class="mb-8 bg-yellow-100 text-yellow-800 px-4 py-2 rounded-full font-bold inline-flex items-center shadow-sm">
                <span class="mr-2" v-html="icons.trophy"></span>
                Best Score: {{ highScore }}
            </div>

            <!-- Region Selector -->
            <button 
                @click="showRegionSelector = true"
                class="mb-6 px-5 py-2 bg-white border-2 border-gray-200 rounded-full text-gray-700 font-bold flex items-center shadow-sm hover:bg-gray-50 transition-colors no-select"
            >
                <span class="mr-2 text-blue-500" v-html="icons.globe"></span>
                Region: {{ selectedRegion }}
            </button>

            <!-- Game Modes Carousel -->
            <div class="w-full overflow-x-auto pb-4 px-4 -mx-4 flex space-x-4 snap-x snap-mandatory no-scrollbar">
                <div 
                    v-for="mode in gameModes" 
                    :key="mode.id"
                    @click="initGame(mode.id)"
                    class="flex-shrink-0 w-40 h-48 rounded-2xl p-4 flex flex-col items-center justify-between border-b-4 active:border-b-0 active:translate-y-1 transition-all shadow-md snap-center relative overflow-hidden cursor-pointer no-select"
                    :class="{
                        'bg-green-500 border-green-700 hover:bg-green-600': mode.color === 'green',
                        'bg-purple-500 border-purple-700 hover:bg-purple-600': mode.color === 'purple',
                        'bg-red-500 border-red-700 hover:bg-red-600': mode.color === 'red',
                        'bg-blue-500 border-blue-700 hover:bg-blue-600': mode.color === 'blue'
                    }"
                >
                    <div class="text-white opacity-90 transform scale-125 mt-4" v-html="mode.icon"></div>
                    
                    <div class="text-center text-white">
                        <div class="text-xl font-black uppercase tracking-wide mb-1">{{ mode.name }}</div>
                        <div class="text-xs font-medium opacity-90 leading-tight">{{ mode.description }}</div>
                    </div>

                    <div class="w-8 h-1 bg-white/30 rounded-full mb-2"></div>
                </div>

                <!-- Coming Soon Card -->
                <div class="flex-shrink-0 w-40 h-48 bg-gray-100 border-b-4 border-gray-300 rounded-2xl p-4 flex flex-col items-center justify-center snap-center opacity-70">
                    <span class="text-3xl mb-2">ðŸš§</span>
                    <span class="font-bold text-gray-400 text-sm">More Soon</span>
                </div>
            </div>
            
            <button @click="screen = 'passport'" class="mt-6 text-blue-500 font-bold flex items-center space-x-2 px-4 py-2 rounded-full hover:bg-blue-50 transition-colors">
                <span v-html="icons.book"></span>
                <span>My Passport</span>
            </button>
        </div>

        <!-- PASSPORT SCREEN -->
        <div v-if="screen === 'passport'" class="flex flex-col h-full bg-gray-50">
            <div class="bg-white shadow-sm px-4 py-4 z-10 flex items-center justify-between safe-top">
                <div class="flex items-center space-x-3">
                    <button @click="screen = 'start'" class="text-gray-500 hover:text-gray-700 bg-gray-100 p-2 rounded-full transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
                    </button>
                    <h2 class="text-xl font-bold text-gray-800">My Passport</h2>
                </div>
                <div class="text-sm font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full">
                    {{ Object.keys(collectedFlags).length }} / {{ totalCountries }}
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4">
                <!-- Region Stats -->
                <div class="grid grid-cols-2 gap-2 mb-6">
                    <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex flex-col items-center justify-center" v-for="region in continents.filter(c => c !== 'World')" :key="region">
                         <span class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-1">{{ region }}</span>
                         <span class="text-lg font-extrabold" :class="getRegionProgress(region) === 100 ? 'text-green-500' : 'text-gray-700'">
                            {{ getRegionCount(region) }}%
                         </span>
                         <div class="w-full h-1.5 bg-gray-100 rounded-full mt-2 overflow-hidden">
                            <div class="h-full bg-green-500 rounded-full" :style="{ width: getRegionProgress(region) + '%' }"></div>
                         </div>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-3 pb-8">
                    <div 
                        v-for="country in COUNTRIES" 
                        :key="country.code"
                        class="aspect-square rounded-xl flex items-center justify-center relative overflow-hidden border-2 transition-all"
                        :class="collectedFlags[country.code] ? 'bg-white border-blue-200 shadow-sm' : 'bg-gray-100 border-gray-200 opacity-60'"
                    >
                        <img 
                            v-if="collectedFlags[country.code]"
                            :src="`https://flagcdn.com/w160/${country.code}.png`" 
                            loading="lazy"
                            class="w-full h-full object-cover"
                            :alt="country.name"
                        >
                        <span v-else class="text-2xl text-gray-300">?</span>
                        
                        <!-- Count Badge -->
                        <div v-if="collectedFlags[country.code] > 1" class="absolute bottom-0 right-0 bg-blue-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-tl-lg">
                            {{ collectedFlags[country.code] }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PLAYING SCREEN -->
        <div v-if="screen === 'playing'" class="flex flex-col h-full relative">
            <!-- Header -->
            <div class="pt-6 pb-6 px-4 flex flex-col bg-white z-10 safe-top">
                <div class="flex items-center justify-between w-full">
                    <button @click="quitGame" class="text-gray-400 hover:text-gray-600 no-select" v-html="icons.x"></button>
                    
                    <div class="flex-1 mx-4 flex items-center space-x-3">
                        <!-- Progress Bar Container -->
                        <div class="flex-1 relative h-4">
                            <!-- Track -->
                            <div class="absolute inset-0 bg-gray-200 rounded-full overflow-hidden border border-gray-300/50">
                                <div 
                                    class="h-full transition-all duration-500 ease-out rounded-full shadow-[0_0_10px_rgba(0,0,0,0.1)]" 
                                    :class="progressBarClass"
                                    :style="{ width: progress + '%' }"
                                ></div>
                            </div>
                        </div>

                        <div class="text-sm font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-md min-w-[60px] text-center">
                            {{ score }}
                        </div>
                    </div>

                    <div class="flex items-center space-x-1">
                        <span v-html="lives > 0 ? icons.heartFilled : icons.heart"></span>
                        <span class="text-xl font-bold text-red-500">{{ lives }}</span>
                    </div>
                </div>
                
                <!-- Blitz Timer -->
                <div v-if="gameMode === 'blitz'" class="w-full mt-3">
                    <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden shadow-inner">
                        <div class="h-full transition-all duration-100 ease-linear" 
                             :class="timeLeft < 2 ? 'bg-red-600 animate-pulse' : 'bg-orange-500'"
                             :style="{ width: (timeLeft / 5) * 100 + '%' }"></div>
                    </div>
                </div>
            </div>

            <!-- Game Board -->
            <div class="flex-1 overflow-y-auto p-4 flex flex-col items-center w-full pb-32">
                <h2 class="text-2xl font-bold text-gray-700 mt-4 mb-6 text-left w-full">
                    {{ gameMode === 'reverse' ? 'Which flag is this?' : 'Which country is this?' }}
                </h2>

                <div class="mb-6 p-4 bg-white rounded-2xl shadow-sm border-2 border-gray-100 w-full flex justify-center items-center min-h-[160px]">
                    <img 
                        v-if="currentQuestion && gameMode !== 'reverse'"
                        :src="`https://flagcdn.com/w640/${currentQuestion.correctOption.code}.png`" 
                        alt="Flag" 
                        class="h-40 w-auto rounded-md shadow-md object-cover border border-gray-200"
                        @error="handleImageError"
                    >
                    <h3 v-if="currentQuestion && gameMode === 'reverse'" class="text-3xl font-extrabold text-gray-800 text-center">
                        {{ currentQuestion.correctOption.name }}
                    </h3>
                </div>

                <!-- Input for Hard Mode -->
                <div v-if="gameMode === 'hard'" class="w-full px-4">
                    <form @submit.prevent="handleAnswer(userAnswer)" class="flex flex-col space-y-4">
                         <input 
                            type="text" 
                            v-model="userAnswer"
                            placeholder="Type country name..." 
                            class="w-full p-4 rounded-xl border-2 border-gray-200 text-lg font-bold text-center focus:outline-none focus:border-blue-500 transition-colors"
                            :class="{'border-green-500 bg-green-50 text-green-700': feedback === 'correct', 'border-red-500 bg-red-50 text-red-700': feedback === 'incorrect'}"
                            :disabled="feedback !== null"
                            autofocus
                        >
                        <button 
                            type="submit" 
                            class="w-full py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-xl shadow-md active:translate-y-0.5 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                            :disabled="!userAnswer || feedback !== null"
                        >
                            Submit Answer
                        </button>
                    </form>
                </div>

                <div class="grid w-full" :class="gameMode === 'reverse' ? 'grid-cols-2 gap-4' : 'grid-cols-1 gap-3'" v-else-if="currentQuestion">
                    <button 
                        v-for="(option, idx) in currentQuestion.options" 
                        :key="option.code"
                        @click="handleAnswer(option, $event)"
                        class="relative w-full rounded-2xl border-2 border-b-4 font-bold transition-all flex items-center justify-between group no-select"
                        :class="[
                            getOptionClass(option),
                            gameMode === 'reverse' ? 'p-2 h-32 flex-col justify-center' : 'p-4 text-lg'
                        ]"
                        :disabled="feedback !== null"
                    >
                        <div class="flex items-center" :class="{'w-full justify-center': gameMode === 'reverse'}">
                            <span 
                                class="flex items-center justify-center w-8 h-8 rounded-lg text-sm border absolute top-2 left-2"
                                :class="getNumberClass(option)"
                                v-if="gameMode === 'reverse'"
                            >
                                {{ idx + 1 }}
                            </span>
                            <span 
                                class="flex items-center justify-center w-8 h-8 rounded-lg text-sm border mr-3"
                                :class="getNumberClass(option)"
                                v-else
                            >
                                {{ idx + 1 }}
                            </span>
                            
                            <span v-if="gameMode !== 'reverse'">{{ option.name }}</span>
                            <img 
                                v-if="gameMode === 'reverse'"
                                :src="`https://flagcdn.com/w320/${option.code}.png`" 
                                alt="Flag" 
                                class="h-20 w-auto rounded shadow-sm object-cover"
                                @error="handleImageError"
                            >
                        </div>
                    </button>
                </div>
            </div>

            <!-- Bottom Sheet -->
            <div 
                class="fixed bottom-0 left-0 right-0 max-w-md mx-auto sheet-transition p-4 border-t-2 flex flex-col z-50 shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.3)]"
                :class="bottomSheetClasses"
            >
                <div class="flex items-center justify-between mb-4 px-2">
                    <div class="flex items-center space-x-3">
                        <div 
                            class="p-2 rounded-full text-white"
                            :class="isCorrect ? 'bg-green-500' : 'bg-red-500'"
                        >
                            <span v-html="isCorrect ? icons.check : icons.x"></span>
                        </div>
                        <div>
                            <h3 
                                class="text-xl font-extrabold"
                                :class="isCorrect ? 'text-green-600' : 'text-red-600'"
                            >
                                {{ isCorrect ? 'Excellent!' : (feedback === 'timeout' ? "Time's Up!" : 'Incorrect') }}
                            </h3>
                            <p v-if="!isCorrect" class="text-red-500 font-medium">
                                Correct: {{ currentQuestion?.correctOption.name }}
                            </p>
                        </div>
                    </div>
                </div>
                <button 
                    @click="nextQuestion" 
                    class="w-full py-3 px-6 rounded-xl font-bold text-white text-lg uppercase tracking-wider border-b-4 active:border-b-0 active:translate-y-1 transition-all shadow-md no-select"
                    :class="isCorrect ? 'bg-green-500 hover:bg-green-600 border-green-700' : 'bg-red-500 hover:bg-red-600 border-red-700'"
                >
                    Continue
                </button>
                <div class="h-4 md:h-0"></div>
            </div>

            <!-- Desktop Hint -->
            <div class="hidden md:block fixed bottom-4 right-4 text-xs text-gray-400 bg-white p-2 rounded border shadow-sm">
                Press <strong>1-4</strong> to answer, <strong>Enter</strong> to continue
            </div>
        </div>

        <!-- END SCREEN -->
        <div v-if="screen === 'end'" class="flex flex-col items-center justify-center h-full p-6 text-center">
            <div class="mb-6">
                <div class="w-32 h-32 mx-auto" :class="lives > 0 ? 'text-yellow-400' : 'text-gray-300'">
                    <span v-html="lives > 0 ? icons.trophyLarge : icons.heartLarge"></span>
                </div>
            </div>
            
            <h2 class="text-3xl font-extrabold text-gray-800 mb-2">
                {{ lives > 0 ? 'World Master!' : 'Out of Hearts!' }}
            </h2>
            
            <div class="bg-gray-100 p-6 rounded-2xl w-full max-w-sm mb-8 border-2 border-gray-200">
                <div class="flex justify-between items-center mb-4 border-b pb-4 border-gray-300">
                    <span class="text-gray-600 font-bold">Total Score</span>
                    <span class="text-2xl font-extrabold text-blue-500">{{ score }}</span>
                </div>
                <div class="flex justify-between items-center mb-4 border-b pb-4 border-gray-300" v-if="highScore > 0">
                    <span class="text-gray-600 font-bold">Best Score</span>
                    <div class="flex items-center">
                        <span v-if="score >= highScore && score > 0" class="mr-2 text-xs bg-yellow-400 text-white px-2 py-1 rounded-full font-bold animate-pulse">NEW!</span>
                        <span class="text-2xl font-extrabold text-yellow-600">{{ highScore }}</span>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600 font-bold">Flags Identified</span>
                    <span class="text-xl font-extrabold text-green-500">{{ currentIndex }}/{{ queue.length }}</span>
                </div>
            </div>

            <!-- Wrong Answers List -->
            <div v-if="wrongAnswers.length > 0" class="w-full max-w-sm mb-6 text-left">
                <div class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-2 pl-1">Review Mistakes</div>
                <div class="bg-white rounded-xl border-2 border-gray-200 shadow-sm overflow-hidden">
                    <div class="max-h-48 overflow-y-auto no-scrollbar">
                        <div v-for="(item, idx) in wrongAnswers" :key="idx" class="p-3 border-b border-gray-100 last:border-0 flex items-center hover:bg-gray-50 transition-colors">
                            <!-- Correct Flag -->
                            <img 
                                :src="`https://flagcdn.com/w160/${item.question.correctOption.code}.png`" 
                                class="w-12 h-8 object-cover rounded shadow-sm border border-gray-200 flex-shrink-0 mr-3"
                                loading="lazy"
                            >
                            <div class="flex-1 min-w-0">
                                <!-- Correct Answer -->
                                <div class="text-sm font-bold text-gray-800 truncate">
                                    {{ item.question.correctOption.name }}
                                </div>
                                <!-- User Mistake -->
                                <div class="text-xs text-red-500 truncate font-medium flex items-center">
                                    <span v-if="item.type === 'timeout'">Time's Up!</span>
                                    
                                    <span v-else-if="typeof item.userAnswer === 'string'">
                                        Typed: "{{ item.userAnswer }}"
                                    </span>
                                    
                                    <span v-else-if="item.userAnswer">
                                        Picked: {{ item.userAnswer.name }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button @click="screen = 'start'" class="w-full max-w-xs bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-2xl border-b-4 border-blue-700 active:border-b-0 active:translate-y-1 transition-all shadow-lg text-lg uppercase tracking-wide flex items-center justify-center space-x-2 no-select">
                <span class="mr-2" v-html="icons.rotateCcw"></span>
                <span>Try Again</span>
            </button>

            <button @click="shareScore" class="mt-4 w-full max-w-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-3 px-8 rounded-2xl border-b-4 border-yellow-600 active:border-b-0 active:translate-y-1 transition-all shadow-md text-lg uppercase tracking-wide flex items-center justify-center space-x-2 no-select">
                <span class="mr-2" v-html="icons.share"></span>
                <span>Share Score</span>
            </button>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted } = Vue;

        // --- DATA ---
        const COUNTRIES = [
            { code: 'ad', name: 'Andorra', continent: 'Europe', difficulty: 'hard' }, 
            { code: 'ae', name: 'United Arab Emirates', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'af', name: 'Afghanistan', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'ag', name: 'Antigua and Barbuda', continent: 'North America', difficulty: 'hard' }, 
            { code: 'al', name: 'Albania', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'am', name: 'Armenia', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'ao', name: 'Angola', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'ar', name: 'Argentina', continent: 'South America', difficulty: 'easy' }, 
            { code: 'at', name: 'Austria', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'au', name: 'Australia', continent: 'Oceania', difficulty: 'easy' }, 
            { code: 'az', name: 'Azerbaijan', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'ba', name: 'Bosnia and Herzegovina', continent: 'Europe', difficulty: 'hard' }, 
            { code: 'bb', name: 'Barbados', continent: 'North America', difficulty: 'medium' }, 
            { code: 'bd', name: 'Bangladesh', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'be', name: 'Belgium', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'bf', name: 'Burkina Faso', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'bg', name: 'Bulgaria', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'bh', name: 'Bahrain', continent: 'Asia', difficulty: 'hard' }, 
            { code: 'bi', name: 'Burundi', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'bj', name: 'Benin', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'bn', name: 'Brunei', continent: 'Asia', difficulty: 'hard' }, 
            { code: 'bo', name: 'Bolivia', continent: 'South America', difficulty: 'medium' }, 
            { code: 'br', name: 'Brazil', continent: 'South America', difficulty: 'easy' }, 
            { code: 'bs', name: 'Bahamas', continent: 'North America', difficulty: 'medium' }, 
            { code: 'bt', name: 'Bhutan', continent: 'Asia', difficulty: 'hard' }, 
            { code: 'bw', name: 'Botswana', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'by', name: 'Belarus', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'bz', name: 'Belize', continent: 'North America', difficulty: 'hard' }, 
            { code: 'ca', name: 'Canada', continent: 'North America', difficulty: 'easy' }, 
            { code: 'cd', name: 'DR Congo', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'cf', name: 'Central African Republic', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'cg', name: 'Congo', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'ch', name: 'Switzerland', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'ci', name: 'Ivory Coast', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'cl', name: 'Chile', continent: 'South America', difficulty: 'easy' }, 
            { code: 'cm', name: 'Cameroon', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'cn', name: 'China', continent: 'Asia', difficulty: 'easy' }, 
            { code: 'co', name: 'Colombia', continent: 'South America', difficulty: 'medium' }, 
            { code: 'cr', name: 'Costa Rica', continent: 'North America', difficulty: 'medium' }, 
            { code: 'cu', name: 'Cuba', continent: 'North America', difficulty: 'medium' }, 
            { code: 'cv', name: 'Cape Verde', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'cy', name: 'Cyprus', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'cz', name: 'Czechia', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'de', name: 'Germany', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'dj', name: 'Djibouti', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'dk', name: 'Denmark', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'dm', name: 'Dominica', continent: 'North America', difficulty: 'hard' }, 
            { code: 'do', name: 'Dominican Republic', continent: 'North America', difficulty: 'medium' }, 
            { code: 'dz', name: 'Algeria', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'ec', name: 'Ecuador', continent: 'South America', difficulty: 'medium' }, 
            { code: 'ee', name: 'Estonia', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'eg', name: 'Egypt', continent: 'Africa', difficulty: 'easy' }, 
            { code: 'er', name: 'Eritrea', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'es', name: 'Spain', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'et', name: 'Ethiopia', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'fi', name: 'Finland', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'fj', name: 'Fiji', continent: 'Oceania', difficulty: 'hard' }, 
            { code: 'fm', name: 'Micronesia', continent: 'Oceania', difficulty: 'hard' }, 
            { code: 'fr', name: 'France', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'ga', name: 'Gabon', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'gb', name: 'United Kingdom', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'gd', name: 'Grenada', continent: 'North America', difficulty: 'hard' }, 
            { code: 'ge', name: 'Georgia', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'gh', name: 'Ghana', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'gm', name: 'Gambia', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'gn', name: 'Guinea', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'gq', name: 'Equatorial Guinea', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'gr', name: 'Greece', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'gt', name: 'Guatemala', continent: 'North America', difficulty: 'medium' }, 
            { code: 'gw', name: 'Guinea-Bissau', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'gy', name: 'Guyana', continent: 'South America', difficulty: 'hard' }, 
            { code: 'hn', name: 'Honduras', continent: 'North America', difficulty: 'medium' }, 
            { code: 'hr', name: 'Croatia', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'ht', name: 'Haiti', continent: 'North America', difficulty: 'medium' }, 
            { code: 'hu', name: 'Hungary', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'id', name: 'Indonesia', continent: 'Asia', difficulty: 'hard' }, 
            { code: 'ie', name: 'Ireland', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'il', name: 'Israel', continent: 'Asia', difficulty: 'easy' }, 
            { code: 'in', name: 'India', continent: 'Asia', difficulty: 'easy' }, 
            { code: 'iq', name: 'Iraq', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'ir', name: 'Iran', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'is', name: 'Iceland', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'it', name: 'Italy', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'jm', name: 'Jamaica', continent: 'North America', difficulty: 'medium' }, 
            { code: 'jo', name: 'Jordan', continent: 'Asia', difficulty: 'hard' }, 
            { code: 'jp', name: 'Japan', continent: 'Asia', difficulty: 'easy' }, 
            { code: 'ke', name: 'Kenya', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'kg', name: 'Kyrgyzstan', continent: 'Asia', difficulty: 'hard' }, 
            { code: 'kh', name: 'Cambodia', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'ki', name: 'Kiribati', continent: 'Oceania', difficulty: 'hard' }, 
            { code: 'km', name: 'Comoros', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'kn', name: 'Saint Kitts and Nevis', continent: 'North America', difficulty: 'hard' }, 
            { code: 'kp', name: 'North Korea', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'kr', name: 'South Korea', continent: 'Asia', difficulty: 'easy' }, 
            { code: 'kw', name: 'Kuwait', continent: 'Asia', difficulty: 'hard' }, 
            { code: 'kz', name: 'Kazakhstan', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'la', name: 'Laos', continent: 'Asia', difficulty: 'hard' }, 
            { code: 'lb', name: 'Lebanon', continent: 'Asia', difficulty: 'hard' }, 
            { code: 'lc', name: 'Saint Lucia', continent: 'North America', difficulty: 'hard' }, 
            { code: 'li', name: 'Liechtenstein', continent: 'Europe', difficulty: 'hard' }, 
            { code: 'lk', name: 'Sri Lanka', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'lr', name: 'Liberia', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'ls', name: 'Lesotho', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'lt', name: 'Lithuania', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'lu', name: 'Luxembourg', continent: 'Europe', difficulty: 'hard' }, 
            { code: 'lv', name: 'Latvia', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'ly', name: 'Libya', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'ma', name: 'Morocco', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'mc', name: 'Monaco', continent: 'Europe', difficulty: 'hard' }, 
            { code: 'md', name: 'Moldova', continent: 'Europe', difficulty: 'hard' }, 
            { code: 'me', name: 'Montenegro', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'mg', name: 'Madagascar', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'mh', name: 'Marshall Islands', continent: 'Oceania', difficulty: 'hard' }, 
            { code: 'mk', name: 'North Macedonia', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'ml', name: 'Mali', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'mm', name: 'Myanmar', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'mn', name: 'Mongolia', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'mr', name: 'Mauritania', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'mt', name: 'Malta', continent: 'Europe', difficulty: 'hard' }, 
            { code: 'mu', name: 'Mauritius', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'mv', name: 'Maldives', continent: 'Asia', difficulty: 'hard' }, 
            { code: 'mw', name: 'Malawi', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'mx', name: 'Mexico', continent: 'North America', difficulty: 'easy' }, 
            { code: 'my', name: 'Malaysia', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'mz', name: 'Mozambique', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'na', name: 'Namibia', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'ne', name: 'Niger', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'ng', name: 'Nigeria', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'ni', name: 'Nicaragua', continent: 'North America', difficulty: 'hard' }, 
            { code: 'nl', name: 'Netherlands', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'no', name: 'Norway', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'np', name: 'Nepal', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'nr', name: 'Nauru', continent: 'Oceania', difficulty: 'hard' }, 
            { code: 'nz', name: 'New Zealand', continent: 'Oceania', difficulty: 'easy' }, 
            { code: 'om', name: 'Oman', continent: 'Asia', difficulty: 'hard' }, 
            { code: 'pa', name: 'Panama', continent: 'North America', difficulty: 'medium' }, 
            { code: 'pe', name: 'Peru', continent: 'South America', difficulty: 'medium' }, 
            { code: 'pg', name: 'Papua New Guinea', continent: 'Oceania', difficulty: 'medium' }, 
            { code: 'ph', name: 'Philippines', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'pk', name: 'Pakistan', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'pl', name: 'Poland', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'pt', name: 'Portugal', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'pw', name: 'Palau', continent: 'Oceania', difficulty: 'hard' }, 
            { code: 'py', name: 'Paraguay', continent: 'South America', difficulty: 'hard' }, 
            { code: 'qa', name: 'Qatar', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'ro', name: 'Romania', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'rs', name: 'Serbia', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'ru', name: 'Russia', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'rw', name: 'Rwanda', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'sa', name: 'Saudi Arabia', continent: 'Asia', difficulty: 'easy' }, 
            { code: 'sb', name: 'Solomon Islands', continent: 'Oceania', difficulty: 'hard' }, 
            { code: 'sc', name: 'Seychelles', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'sd', name: 'Sudan', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'se', name: 'Sweden', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'sg', name: 'Singapore', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'si', name: 'Slovenia', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'sk', name: 'Slovakia', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'sl', name: 'Sierra Leone', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'sm', name: 'San Marino', continent: 'Europe', difficulty: 'hard' }, 
            { code: 'sn', name: 'Senegal', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'so', name: 'Somalia', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'sr', name: 'Suriname', continent: 'South America', difficulty: 'hard' }, 
            { code: 'ss', name: 'South Sudan', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'st', name: 'Sao Tome and Principe', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'sv', name: 'El Salvador', continent: 'North America', difficulty: 'medium' }, 
            { code: 'sy', name: 'Syria', continent: 'Asia', difficulty: 'hard' }, 
            { code: 'sz', name: 'Eswatini', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'td', name: 'Chad', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'tg', name: 'Togo', continent: 'Africa', difficulty: 'hard' }, 
            { code: 'th', name: 'Thailand', continent: 'Asia', difficulty: 'easy' }, 
            { code: 'tj', name: 'Tajikistan', continent: 'Asia', difficulty: 'hard' }, 
            { code: 'tl', name: 'Timor-Leste', continent: 'Asia', difficulty: 'hard' }, 
            { code: 'tm', name: 'Turkmenistan', continent: 'Asia', difficulty: 'hard' }, 
            { code: 'tn', name: 'Tunisia', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'to', name: 'Tonga', continent: 'Oceania', difficulty: 'hard' }, 
            { code: 'tr', name: 'Turkey', continent: 'Asia', difficulty: 'easy' }, 
            { code: 'tt', name: 'Trinidad and Tobago', continent: 'North America', difficulty: 'medium' }, 
            { code: 'tv', name: 'Tuvalu', continent: 'Oceania', difficulty: 'hard' }, 
            { code: 'tw', name: 'Taiwan', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'tz', name: 'Tanzania', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'ua', name: 'Ukraine', continent: 'Europe', difficulty: 'easy' }, 
            { code: 'ug', name: 'Uganda', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'us', name: 'United States', continent: 'North America', difficulty: 'easy' }, 
            { code: 'uy', name: 'Uruguay', continent: 'South America', difficulty: 'medium' }, 
            { code: 'uz', name: 'Uzbekistan', continent: 'Asia', difficulty: 'hard' }, 
            { code: 'va', name: 'Vatican City', continent: 'Europe', difficulty: 'medium' }, 
            { code: 'vc', name: 'Saint Vincent and the Grenadines', continent: 'North America', difficulty: 'hard' }, 
            { code: 've', name: 'Venezuela', continent: 'South America', difficulty: 'medium' }, 
            { code: 'vn', name: 'Vietnam', continent: 'Asia', difficulty: 'medium' }, 
            { code: 'vu', name: 'Vanuatu', continent: 'Oceania', difficulty: 'hard' }, 
            { code: 'ws', name: 'Samoa', continent: 'Oceania', difficulty: 'hard' }, 
            { code: 'ye', name: 'Yemen', continent: 'Asia', difficulty: 'hard' }, 
            { code: 'za', name: 'South Africa', continent: 'Africa', difficulty: 'easy' }, 
            { code: 'zm', name: 'Zambia', continent: 'Africa', difficulty: 'medium' }, 
            { code: 'zw', name: 'Zimbabwe', continent: 'Africa', difficulty: 'medium' }
        ];
        
        const SIMILAR_FLAGS = {
            'ro': ['td', 'ad', 'md'], // Romania -> Chad, Andorra, Moldova
            'td': ['ro', 'ad', 'md'], // Chad -> Romania...
            'id': ['mc', 'pl', 'sg'], // Indonesia -> Monaco, Poland, Singapore
            'mc': ['id', 'pl', 'sg'],
            'pl': ['id', 'mc', 'sg'],
            'ie': ['ci', 'it'], // Ireland -> Ivory Coast, Italy
            'ci': ['ie', 'it'],
            'nz': ['au', 'gb'], // NZ -> Australia, UK
            'au': ['nz', 'gb'],
            'ml': ['gn', 'gh'], // Mali -> Guinea, Ghana
            'gn': ['ml', 'gh', 'gw'],
            've': ['ec', 'co'], // Venezuela -> Ecuador, Colombia
            'ec': ['ve', 'co'],
            'co': ['ve', 'ec'],
            'lu': ['nl', 'py', 'fr'], // Luxembourg -> Netherlands, Paraguay, France
            'nl': ['lu', 'py', 'fr'],
            'hr': ['rs', 'si', 'sk', 'ru'], // Croatia -> Serbia, Slovenia, Slovakia, Russia
            'rs': ['hr', 'si', 'sk', 'ru'],
            'si': ['hr', 'rs', 'sk', 'ru'],
            'sk': ['hr', 'rs', 'si', 'ru'],
            'ru': ['si', 'sk', 'rs'],
            'no': ['is', 'dk', 'fi', 'se'], // Nordic Crosses
            'is': ['no', 'dk', 'fi', 'se'],
            'dk': ['no', 'is', 'fi', 'se'],
            'fi': ['no', 'is', 'dk', 'se'],
            'se': ['no', 'is', 'dk', 'fi'],
            'us': ['lr', 'my'], // USA -> Liberia, Malaysia
            'lr': ['us', 'my', 'cl'],
            'my': ['us', 'lr'],
            'cu': ['pr', 'ph'], // Cuba -> Puerto Rico (not in list but similar style), Philippines
            'cl': ['tx', 'lr'], // Chile -> Texas (lol), Liberia
            'jp': ['bd', 'pw'], // Japan -> Bangladesh, Palau
            'bd': ['jp', 'pw'],
            'tr': ['tn', 'pk'], // Turkey -> Tunisia, Pakistan
            'tn': ['tr', 'pk', 'dz'],
            'cn': ['vn', 'su'], // China -> Vietnam, USSR(hist)
            'vn': ['cn', 'ma'],
            'so': ['vn', 'mm'], // Somalia (star)
            'qa': ['bh'], // Qatar -> Bahrain
            'bh': ['qa'],
            'sv': ['ni', 'hn', 'gt', 'ar'], // Central American blue/white
            'ni': ['sv', 'hn', 'gt', 'ar'],
            'hn': ['sv', 'ni', 'gt', 'ar'],
            'gt': ['sv', 'ni', 'hn', 'ar'],
            'ar': ['sv', 'ni', 'hn', 'gt', 'uy'],
        };

        const ICONS = {
            heart: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>`,
            heartFilled: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>`,
            trophy: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
            trophyLarge: `<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
            heartLarge: `<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>`,
            x: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
            check: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`,
            rotateCcw: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/></svg>`,
            share: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>`,
            lightning: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
            book: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>`,
            globe: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>`,
            gear: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>`,
            volume: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>`,
            volumeOff: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>`
        };

        createApp({
            setup() {
                // State
                const screen = ref('start'); // start, playing, end
                const gameMode = ref('normal'); // normal, reverse, blitz
                const score = ref(0);
                const lives = ref(3);
                const streak = ref(0);
                const wrongAnswers = ref([]);
                const highScore = ref(0);
                const queue = ref([]);
                const currentIndex = ref(0);
                const currentQuestion = ref(null);
                const selectedOption = ref(null);
                const feedback = ref(null); // 'correct', 'incorrect', 'timeout', null
                const lastFeedback = ref(null); // To persist feedback during transition
                const hasCelebratedHighScore = ref(false);
                const userAnswer = ref(''); // For hard mode
                
                // Passport / Collection State
                const collectedFlags = ref({}); // { 'us': 1, 'fr': 3 } - counts of correct answers

                // Region Filter
                const selectedRegion = ref('World');
                const showRegionSelector = ref(false);
                const continents = ['World', 'Africa', 'Asia', 'Europe', 'North America', 'Oceania', 'South America'];
                
                // Settings State
                const soundEnabled = ref(true);
                const showSettings = ref(false);

                // Timer State (Blitz Mode)
                const timerInterval = ref(null);
                const timeLeft = ref(0);
                const BLITZ_TIME = 5; // seconds
                const autoAdvanceTimer = ref(null);
                
                let audioContext = null;
                let fireworksInstance = null;
                const fireworksContainer = ref(null);
                
                // Visual Effects State
                const floatingPoints = ref([]);
                const shakeActive = ref(false);
                let pointIdCounter = 0;

                // Game Modes Config
                const gameModes = [
                    { 
                        id: 'normal', 
                        name: 'Normal', 
                        description: 'Identify the flag shown',
                        color: 'green',
                        icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>`
                    },
                    { 
                        id: 'reverse', 
                        name: 'Reverse', 
                        description: 'Find the flag for the country',
                        color: 'purple',
                        icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"/><line x1="1" y1="3" x2="23" y2="3"/><line x1="12" y1="14" x2="12" y2="21"/></svg>`
                    },
                    { 
                        id: 'blitz', 
                        name: 'Blitz', 
                        description: 'Fast-paced timed challenge',
                        color: 'red',
                        icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`
                    },
                    { 
                        id: 'hard', 
                        name: 'Hard', 
                        description: 'Type the country name',
                        color: 'blue',
                        icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`
                    }
                ];

                // Logic
                const triggerFloatingPoints = (x, y, amount) => {
                    const id = pointIdCounter++;
                    // Adjust x/y to be relative to the app container if possible, 
                    // or just use client coordinates if the container is fixed/relative properly.
                    // Since the floating points are in absolute container inside #app,
                    // we need coordinates relative to #app.
                    
                    const appRect = document.getElementById('app').getBoundingClientRect();
                    const relativeX = x - appRect.left;
                    const relativeY = y - appRect.top;

                    floatingPoints.value.push({ id, x: relativeX, y: relativeY, amount });
                    
                    setTimeout(() => {
                        floatingPoints.value = floatingPoints.value.filter(p => p.id !== id);
                    }, 800);
                };

                const triggerShake = () => {
                    shakeActive.value = true;
                    setTimeout(() => {
                        shakeActive.value = false;
                    }, 500);
                };

                const loadScript = (src) => {
                    return new Promise((resolve, reject) => {
                        if (document.querySelector(`script[src="${src}"]`)) {
                            resolve();
                            return;
                        }
                        const script = document.createElement('script');
                        script.src = src;
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                };

                const levenshtein = (a, b) => {
                    const matrix = [];
                    for (let i = 0; i <= b.length; i++) matrix[i] = [i];
                    for (let j = 0; j <= a.length; j++) matrix[0][j] = j;

                    for (let i = 1; i <= b.length; i++) {
                        for (let j = 1; j <= a.length; j++) {
                            if (b.charAt(i - 1) === a.charAt(j - 1)) {
                                matrix[i][j] = matrix[i - 1][j - 1];
                            } else {
                                matrix[i][j] = Math.min(
                                    matrix[i - 1][j - 1] + 1,
                                    Math.min(
                                        matrix[i][j - 1] + 1,
                                        matrix[i - 1][j] + 1
                                    )
                                );
                            }
                        }
                    }
                    return matrix[b.length][a.length];
                };

                const shuffleArray = (array) => {
                    const newArray = [...array];
                    for (let i = newArray.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                    }
                    return newArray;
                };

                const generateQuestion = () => {
                    // Determine target difficulty based on streak
                    // Streak 0-2: Easy (or mix)
                    // Streak 3-5: Medium
                    // Streak 6+: Hard
                    let targetDifficulty = 'medium';
                    if (streak.value < 3) targetDifficulty = 'easy';
                    else if (streak.value > 5) targetDifficulty = 'hard';

                    // If struggling (low lives), bias towards easy
                    if (lives.value === 1) targetDifficulty = 'easy';

                    // Filter available countries by difficulty if possible
                    let availablePool = COUNTRIES.filter(c => !queue.value.includes(c)); // Simplified: In a real endless mode we'd pick from non-recent
                    
                    // Note: The original game logic used a fixed 'queue' shuffled at start.
                    // To support adaptive difficulty, we need to pick the *next* question dynamically,
                    // rather than pre-determining the whole list. 
                    // However, 'queue' is currently used for progress tracking (currentIndex / queue.length).
                    // For now, let's keep using the queue but we might need to resort it or just pick 
                    // from the remaining items in the queue that match our criteria.
                    
                    // Let's look at the *next* item in the pre-shuffled queue as the "base" choice,
                    // but maybe we can swap it with something else in the queue if it doesn't match our difficulty target?
                    // Or, for true adaptive difficulty, we should just pick a random unasked country that fits the criteria.
                    
                    // Since rewriting the whole queue logic is a bigger refactor, let's do this:
                    // We will stick to the current correctOption (queue[currentIndex]), BUT we will 
                    // make the DISTRACTORS smart. 
                    // AND, if we want to truly change the *Question* difficulty, we would need to shuffle the queue 
                    // so that a 'Hard' country comes next.
                    
                    // Strategy: Look ahead in the queue. Find the first country that matches targetDifficulty.
                    // Swap it with the current position.
                    
                    let correctOption = queue.value[currentIndex.value];
                    
                    // Try to find a better candidate in the future queue
                    const futureIndex = queue.value.slice(currentIndex.value).findIndex(c => c.difficulty === targetDifficulty);
                    if (futureIndex !== -1) {
                        const actualIndex = currentIndex.value + futureIndex;
                        // Swap
                        const temp = queue.value[currentIndex.value];
                        queue.value[currentIndex.value] = queue.value[actualIndex];
                        queue.value[actualIndex] = temp;
                        correctOption = queue.value[currentIndex.value];
                    }

                    // Pick 3 distractors
                    const distractors = [];
                    
                    // 1. Similarity Traps (Priority)
                    if (SIMILAR_FLAGS[correctOption.code]) {
                        const traps = SIMILAR_FLAGS[correctOption.code];
                        // Shuffle traps
                        const shuffledTraps = shuffleArray(traps);
                        
                        for (const trapCode of shuffledTraps) {
                            const trapCountry = COUNTRIES.find(c => c.code === trapCode);
                            if (trapCountry && distractors.length < 3) {
                                distractors.push(trapCountry);
                            }
                        }
                    }

                    // 2. Filter available distractors (Region based if possible)
                    let availableDistractors = COUNTRIES.filter(c => c.code !== correctOption.code && !distractors.includes(c));
                    if (selectedRegion.value !== 'World') {
                        availableDistractors = availableDistractors.filter(c => c.continent === selectedRegion.value);
                    }
                    
                    // Fallback if not enough
                    if (availableDistractors.length < 3) {
                         availableDistractors = COUNTRIES.filter(c => c.code !== correctOption.code && !distractors.includes(c));
                    }
                    
                    // Fill remaining spots
                    while (distractors.length < 3) {
                        const randomIndex = Math.floor(Math.random() * availableDistractors.length);
                        const randomDistractor = availableDistractors[randomIndex];
                        // Check distinctness again just in case
                        if (!distractors.includes(randomDistractor)) {
                            distractors.push(randomDistractor);
                            // Remove from pool to avoid dupes
                            availableDistractors.splice(randomIndex, 1);
                        }
                    }
                    
                    const options = shuffleArray([correctOption, ...distractors]);
                    
                    return { correctOption, options };
                };

                const initAudio = () => {
                    if (!audioContext) {
                        const AudioContext = window.AudioContext || window.webkitAudioContext;
                        if (AudioContext) {
                            audioContext = new AudioContext();
                        }
                    }
                    if (audioContext && audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                };

                // Timer Logic
                const startTimer = () => {
                    if (gameMode.value !== 'blitz') return;
                    
                    clearInterval(timerInterval.value);
                    timeLeft.value = BLITZ_TIME;
                    
                    timerInterval.value = setInterval(() => {
                        timeLeft.value -= 0.05; // Update every 50ms
                        if (timeLeft.value <= 0) {
                            timeLeft.value = 0;
                            clearInterval(timerInterval.value);
                            handleTimeUp();
                        }
                    }, 50);
                };

                const handleTimeUp = () => {
                    if (feedback.value !== null) return;
                    
                    wrongAnswers.value.push({
                        question: currentQuestion.value,
                        userAnswer: null,
                        type: 'timeout'
                    });

                    feedback.value = 'timeout';
                    lastFeedback.value = 'timeout';
                    lives.value = 0; // Instant death in blitz
                    streak.value = 0;
                    
                    playSound('incorrect');
                };

                const initGame = (mode = 'normal') => {
                    initAudio();
                    gameMode.value = mode;
                    score.value = 0;
                    lives.value = mode === 'blitz' ? 1 : 3;
                    streak.value = 0;
                    wrongAnswers.value = [];
                    hasCelebratedHighScore.value = false;
                    
                    // Filter Countries
                    let filteredCountries = COUNTRIES;
                    if (selectedRegion.value !== 'World') {
                        filteredCountries = COUNTRIES.filter(c => c.continent === selectedRegion.value);
                    }
                    
                    queue.value = shuffleArray(filteredCountries);
                    currentIndex.value = 0;
                    selectedOption.value = null;
                    feedback.value = null;
                    lastFeedback.value = null;
                    currentQuestion.value = generateQuestion();
                    screen.value = 'playing';
                    userAnswer.value = '';

                    if (mode === 'blitz') {
                        startTimer();
                    }
                };

                // Audio Logic
                const playSound = (type) => {
                    if (!soundEnabled.value) return;
                    if (!audioContext) return;
                    
                    const ctx = audioContext;
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    
                    if (type === 'correct') {
                        // High pitched "ding"
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(523.25, ctx.currentTime); // C5
                        osc.frequency.exponentialRampToValueAtTime(1046.5, ctx.currentTime + 0.1); // C6
                        gain.gain.setValueAtTime(0.3, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                        osc.start(ctx.currentTime);
                        osc.stop(ctx.currentTime + 0.3);
                    } else if (type === 'incorrect') {
                        // Low pitched "buzz"
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(150, ctx.currentTime);
                        osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.2);
                        gain.gain.setValueAtTime(0.3, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                        osc.start(ctx.currentTime);
                        osc.stop(ctx.currentTime + 0.3);
                    }
                };

                // Confetti Logic
                const triggerConfetti = () => {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                };

                const triggerEmojiRain = () => {
                    const emojis = ['ðŸŒ', 'ðŸŒŽ', 'ðŸŒ', 'ðŸ—ºï¸', 'ðŸš©', 'ðŸŽŒ', 'ðŸ³ï¸'];
                    const end = Date.now() + 1000;
                    
                    (function frame() {
                        confetti({
                            particleCount: 3,
                            angle: 60,
                            spread: 55,
                            origin: { x: 0 },
                            shapes: ['circle'],
                            scalar: 2,
                            contents: emojis
                        });
                        confetti({
                            particleCount: 3,
                            angle: 120,
                            spread: 55,
                            origin: { x: 1 },
                            shapes: ['circle'],
                            scalar: 2,
                            contents: emojis
                        });

                        if (Date.now() < end) {
                            requestAnimationFrame(frame);
                        }
                    }());
                };

                const triggerFireworks = () => {
                    const duration = 1000;
                    const animationEnd = Date.now() + duration;
                    const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

                    const randomInRange = (min, max) => Math.random() * (max - min) + min;

                    const interval = setInterval(function() {
                        const timeLeft = animationEnd - Date.now();

                        if (timeLeft <= 0) {
                            return clearInterval(interval);
                        }

                        const particleCount = 50 * (timeLeft / duration);
                        confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                        confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
                    }, 250);
                };

                const triggerSchoolPride = () => {
                    const end = Date.now() + 1000;
                    const colors = ['#bb0000', '#ffffff'];

                    (function frame() {
                        confetti({
                            particleCount: 2,
                            angle: 60,
                            spread: 55,
                            origin: { x: 0 },
                            colors: colors
                        });
                        confetti({
                            particleCount: 2,
                            angle: 120,
                            spread: 55,
                            origin: { x: 1 },
                            colors: colors
                        });

                        if (Date.now() < end) {
                            requestAnimationFrame(frame);
                        }
                    }());
                };
                
                const triggerPride = () => {
                    const colors = ['#FF0018', '#FFA52C', '#FFFF41', '#008018', '#0000F9', '#86007D'];
                    confetti({
                        particleCount: 150,
                        spread: 100,
                        origin: { y: 0.6 },
                        colors: colors,
                        disableForReducedMotion: true
                    });
                };

                const triggerRealFireworks = async () => {
                    try {
                        await loadScript('https://cdn.jsdelivr.net/npm/fireworks-js@2.10.8/dist/index.umd.js');
                        
                        if (!fireworksInstance && fireworksContainer.value) {
                            const Fireworks = window.Fireworks.default || window.Fireworks;
                            fireworksInstance = new Fireworks(fireworksContainer.value, {
                                hue: { min: 0, max: 360 },
                                delay: { min: 30, max: 60 },
                                rocketsPoint: { min: 50, max: 50 },
                                speed: 2,
                                acceleration: 1.05,
                                friction: 0.98,
                                gravity: 1.5,
                                particles: 50,
                                trace: 3,
                                explosion: 5,
                                autoresize: true,
                                brightness: { min: 50, max: 80, decay: { min: 0.015, max: 0.03 } },
                                boundaries: { top: 50, bottom: fireworksContainer.value.clientHeight, left: 50, right: fireworksContainer.value.clientWidth }
                            });
                        }

                        if (fireworksInstance) {
                            fireworksInstance.start();
                            setTimeout(() => {
                                fireworksInstance.stop();
                            }, 3000);
                        }
                    } catch (e) {
                        console.error('Failed to load fireworks', e);
                        triggerConfetti(); // Fallback
                    }
                };

                const triggerCelebration = () => {
                    const celebrations = [triggerConfetti, triggerFireworks, triggerSchoolPride, triggerPride, triggerRealFireworks];
                    const randomCelebration = celebrations[Math.floor(Math.random() * celebrations.length)];
                    randomCelebration();
                };

                const handleAnswer = (option, event = null) => {
                    if (feedback.value !== null) return; // Already answered

                    clearInterval(timerInterval.value);
                    
                    let isCorrect = false;
                    let isPerfect = false;
                    const correctCode = currentQuestion.value.correctOption.code;

                    if (gameMode.value === 'hard') {
                        // Hard Mode Logic
                        const input = (typeof option === 'string' ? option : userAnswer.value).trim().toLowerCase();
                        const correctName = currentQuestion.value.correctOption.name.toLowerCase();
                        
                        const maxDistance = correctName.length <= 4 ? 1 : 2;
                        const dist = levenshtein(input, correctName);

                        if (dist === 0) {
                            isCorrect = true;
                            isPerfect = true;
                        } else if (dist <= maxDistance) {
                            isCorrect = true;
                        }
                    } else {
                        // Standard Logic
                        selectedOption.value = option;
                        isCorrect = option.code === correctCode;
                    }

                    if (isCorrect) {
                        feedback.value = 'correct';
                        lastFeedback.value = 'correct';
                        let points = 10 + (streak.value * 2);
                        
                        if (gameMode.value === 'blitz') {
                            // Speed bonus: more points for answering faster
                            // Up to 50 extra points (10 per second remaining)
                            points += Math.ceil(timeLeft.value * 10);
                        } else if (gameMode.value === 'hard') {
                            points += 10; // Hard mode base bonus
                            if (isPerfect) points += 20; // Perfect spelling bonus
                        }

                        score.value += points;
                        streak.value += 1;
                        
                        // Visual Effects
                        if (event) {
                            // Use click coordinates
                            triggerFloatingPoints(event.clientX, event.clientY, points);
                        } else {
                            // Keyboard or default: Center of screen
                            const appRect = document.getElementById('app').getBoundingClientRect();
                            triggerFloatingPoints(appRect.left + appRect.width / 2, appRect.top + appRect.height / 2, points);
                        }

                        // Sound & Haptics
                        playSound('correct');
                        
                        // Update High Score
                        let beatHighScore = false;
                        // Only confetti if we actually beat a *previous* high score that was > 0
                        if (score.value > highScore.value) {
                            const previousHigh = highScore.value;
                            highScore.value = score.value;
                            localStorage.setItem('flag-master-highscore', highScore.value);

                            if (previousHigh > 0 && !hasCelebratedHighScore.value) {
                                beatHighScore = true;
                                hasCelebratedHighScore.value = true;
                            }
                        }
                        
                        // Update Passport
                        if (!collectedFlags.value[correctCode]) {
                            collectedFlags.value[correctCode] = 0;
                        }
                        collectedFlags.value[correctCode]++;
                        localStorage.setItem('flag-master-collection', JSON.stringify(collectedFlags.value));

                        if (beatHighScore) {
                            // Confetti for NEW High Score (First time only this run, if beating a non-zero record)
                            triggerCelebration();
                        } else if (streak.value > 0 && streak.value % 5 === 0) {
                            // Confetti every 5 streak
                            triggerCelebration();
                        } else if (isPerfect && gameMode.value === 'hard') {
                            triggerConfetti();
                        }

                        if (gameMode.value === 'blitz') {
                            autoAdvanceTimer.value = setTimeout(() => {
                                nextQuestion();
                            }, 600);
                        }
                    } else {
                        feedback.value = 'incorrect';
                        lastFeedback.value = 'incorrect';
                        lives.value -= 1;
                        streak.value = 0;

                        wrongAnswers.value.push({
                            question: currentQuestion.value,
                            userAnswer: gameMode.value === 'hard' ? userAnswer.value : option,
                            type: 'incorrect'
                        });

                        // Visual Effects
                        triggerShake();

                        // Sound & Haptics
                        playSound('incorrect');
                    }
                };

                const nextQuestion = () => {
                    if (autoAdvanceTimer.value) {
                        clearTimeout(autoAdvanceTimer.value);
                        autoAdvanceTimer.value = null;
                    }

                    if (lives.value <= 0) {
                        screen.value = 'end';
                    } else if (currentIndex.value >= queue.value.length - 1) {
                        screen.value = 'end';
                    } else {
                        currentIndex.value += 1;
                        currentQuestion.value = generateQuestion();
                        selectedOption.value = null;
                        feedback.value = null;
                        userAnswer.value = '';
                        if (gameMode.value === 'blitz') {
                            startTimer();
                        }
                    }
                };

                const quitGame = () => {
                    clearInterval(timerInterval.value);
                    if (autoAdvanceTimer.value) clearTimeout(autoAdvanceTimer.value);
                    
                    // Reset critical state
                    screen.value = 'start';
                    score.value = 0;
                    streak.value = 0;
                    lives.value = 3;
                    currentIndex.value = 0;
                    feedback.value = null;
                    userAnswer.value = '';
                };

                const handleImageError = (e) => {
                    e.target.onerror = null;
                    e.target.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
                };

                const shareScore = async () => {
                    const modeName = gameMode.value === 'normal' ? 'Normal' : gameMode.value === 'reverse' ? 'Reverse' : 'Blitz';
                    const text = `I scored ${score.value} points in Flag Master (${modeName} Mode)! ðŸ³ï¸ Can you beat me?`;
                    const url = window.location.href;
                    
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: `ðŸ† Flag Master Score: ${score.value}`,
                                text: text,
                                url: url
                            });
                        } catch (err) {
                            console.log('Share cancelled or failed', err);
                        }
                    } else {
                        try {
                            await navigator.clipboard.writeText(`${text} ${url}`);
                            alert('Score copied to clipboard!');
                        } catch (err) {
                            console.error('Failed to copy: ', err);
                        }
                    }
                };

                // Computed
                const progress = computed(() => ((currentIndex.value) / queue.value.length) * 100);
                const isCorrect = computed(() => {
                    if (feedback.value !== null) {
                        return feedback.value === 'correct';
                    }
                    return lastFeedback.value === 'correct';
                });
                const totalCountries = computed(() => COUNTRIES.length);

                // Dynamic Classes
                const getOptionClass = (option) => {
                    let classes = '';
                    if (feedback.value !== null) {
                        if (option.code === currentQuestion.value.correctOption.code) {
                            classes = "bg-green-100 border-green-500 text-green-700";
                        } else if (selectedOption.value && selectedOption.value.code === option.code) {
                            classes = "bg-red-100 border-red-500 text-red-700";
                        } else {
                            classes = "bg-white border-gray-200 opacity-50 text-gray-400";
                        }
                    } else {
                        if (selectedOption.value === option) {
                            classes = "bg-blue-100 border-blue-500 text-blue-700";
                        } else {
                            classes = "bg-white border-gray-200 hover:bg-gray-50 text-gray-700 active:border-b-2 active:translate-y-[2px]";
                        }
                    }
                    return classes;
                };

                const progressBarClass = computed(() => {
                    if (streak.value < 3) {
                        return 'bg-green-500';
                    } else if (streak.value < 6) {
                        // Warming up: Yellow to Orange
                        return 'bg-gradient-to-r from-yellow-400 to-orange-500';
                    } else if (streak.value < 10) {
                        // Hot: Orange to Red
                        return 'bg-gradient-to-r from-orange-500 to-red-600 shadow-[0_0_15px_rgba(220,38,38,0.5)]';
                    } else {
                        // Supernova: Red -> Pink -> Purple (Animated Pulse)
                        return 'bg-gradient-to-r from-red-500 via-pink-500 to-purple-600 animate-pulse shadow-[0_0_20px_rgba(236,72,153,0.6)]';
                    }
                });

                const getNumberClass = (option) => {
                    if (feedback.value !== null) {
                        if (option.code === currentQuestion.value.correctOption.code) {
                            return "border-green-500 text-green-700 bg-green-200";
                        } else if (selectedOption.value && selectedOption.value.code === option.code) {
                            return "border-red-500 text-red-700 bg-red-200";
                        } else {
                            return "border-gray-200 bg-white";
                        }
                    } else {
                        if (selectedOption.value === option) {
                            return "border-blue-500 text-blue-700 bg-blue-200";
                        } else {
                            return "border-gray-200 text-gray-400 bg-white";
                        }
                    }
                };

                const bottomSheetClasses = computed(() => {
                    let classes = isCorrect.value ? "bg-green-100 border-green-200" : "bg-red-100 border-red-200";
                    if (feedback.value === null) {
                        classes += " translate-y-full";
                    } else {
                        classes += " translate-y-0";
                    }
                    return classes;
                });

                // Keyboard Events
                const handleKeydown = (e) => {
                    if (screen.value === 'playing') {
                        if (['1', '2', '3', '4'].includes(e.key) && feedback.value === null) {
                            const index = parseInt(e.key) - 1;
                            if (currentQuestion.value && currentQuestion.value.options[index]) {
                                handleAnswer(currentQuestion.value.options[index]);
                            }
                        }
                        if (e.key === 'Enter' && feedback.value !== null) {
                            nextQuestion();
                        }
                    } else if (screen.value === 'start') {
                        if (e.key === 'Enter') {
                            initGame('normal');
                        }
                    } else if (screen.value === 'end') {
                        if (e.key === 'Enter') {
                            screen.value = 'start';
                        }
                    }
                };

                // Prevent Zoom
                const handleGestureStart = (e) => {
                    e.preventDefault();
                }

                onMounted(() => {
                    
                    window.addEventListener('keydown', handleKeydown);
                    document.addEventListener('gesturestart', handleGestureStart);
                    
                    // Load High Score
                    const savedScore = localStorage.getItem('flag-master-highscore');
                    if (savedScore) {
                        highScore.value = parseInt(savedScore);
                    }
                    
                    // Load Passport
                    const savedCollection = localStorage.getItem('flag-master-collection');
                    if (savedCollection) {
                        try {
                            collectedFlags.value = JSON.parse(savedCollection);
                        } catch (e) {
                            console.error('Failed to load collection', e);
                            collectedFlags.value = {};
                        }
                    }

                    // Load Settings
                    const savedSettings = localStorage.getItem('flag-master-settings');
                    if (savedSettings) {
                        try {
                            const parsed = JSON.parse(savedSettings);
                            if (parsed.sound !== undefined) soundEnabled.value = parsed.sound;
                        } catch(e) {}
                    }

                    // Watchers to save settings
                    Vue.watch(soundEnabled, () => {
                        localStorage.setItem('flag-master-settings', JSON.stringify({
                            sound: soundEnabled.value
                        }));
                    });
                });

                onUnmounted(() => {
                    clearInterval(timerInterval.value);
                    if (autoAdvanceTimer.value) clearTimeout(autoAdvanceTimer.value);
                    window.removeEventListener('keydown', handleKeydown);
                    document.removeEventListener('gesturestart', handleGestureStart);
                });

                    return {
                    screen,
                    gameMode,
                    score,
                    lives,
                    highScore,
                    currentIndex,
                    currentQuestion,
                    selectedOption,
                    feedback,
                    userAnswer,
                    initGame,
                    handleAnswer,
                    nextQuestion,
                    quitGame,
                    handleImageError,
                    shareScore,
                    progress,
                    isCorrect,
                    totalCountries,
                    getOptionClass,
                    getNumberClass,
                    bottomSheetClasses,
                    timeLeft,
                    showRegionSelector,
                    selectedRegion,
                    continents,
                    collectedFlags,
                    soundEnabled,
                    showSettings,
                    fireworksContainer,
                    floatingPoints,
                    shakeActive,
                    streak,
                    wrongAnswers,
                    progressBarClass,
                    icons: ICONS,
                    queue,
                    shakeActive,
                    gameModes,
                    getRegionCount: (region) => {
                        const regionCountries = COUNTRIES.filter(c => c.continent === region);
                        const collected = regionCountries.filter(c => collectedFlags.value[c.code]);
                        return Math.round((collected.length / regionCountries.length) * 100);
                    },
                    getRegionProgress: (region) => {
                        const regionCountries = COUNTRIES.filter(c => c.continent === region);
                        const collected = regionCountries.filter(c => collectedFlags.value[c.code]);
                        return (collected.length / regionCountries.length) * 100;
                    }
                };
            }
        }).mount('#app');
    </script>
</body>
</html>