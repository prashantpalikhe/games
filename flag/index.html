<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- iOS / PWA Setup -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Flag Master">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="icon" type="image/png" href="/flag/icon.png">
    <link rel="apple-touch-icon" href="/flag/icon.png">

    <title>Flag Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <style>
        /* Force full height and background for iOS status bar area */
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
        }
        
        html {
            height: 100%;
            background-color: #ffffff;
            padding: 0;
            margin: 0;
        }
        
        body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            /* Extend background to status bar */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        /* Custom utilities for animations */
        @keyframes bounce-custom {
            0%, 100% { transform: translateY(-10%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }
        .animate-bounce-custom {
            animation: bounce-custom 1s infinite;
        }
        
        /* Safe area for notch */
        .safe-top {
            padding-top: var(--safe-top);
        }
        
        /* Smooth transitions for the bottom sheet */
        .sheet-transition {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Prevent highlighting text on rapid clicks */
        .no-select {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* Disable touch actions for zoom and bounce */
        html, body {
            touch-action: manipulation;
            overscroll-behavior: none;
        }

        /* Fade transition for screens */
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }
    </style>
</head>
<body class="bg-white text-gray-800 font-sans overflow-hidden flex justify-center items-center">
    

    <!-- App Container -->
    <div id="app" class="w-full max-w-md h-full max-h-[900px] bg-white shadow-2xl relative overflow-hidden flex flex-col md:rounded-xl md:h-[90vh] md:mt-0">
        
        <!-- Region Selector Modal -->
        <div v-if="showRegionSelector" class="fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm animate-fade-in">
            <div class="bg-white w-full max-w-md md:rounded-2xl rounded-t-2xl p-6 pb-10 md:pb-6 animate-bounce-custom-small shadow-2xl" @click.stop>
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Select Region</h3>
                    <button @click="showRegionSelector = false" class="text-gray-400 hover:text-gray-600 bg-gray-100 rounded-full p-1" v-html="icons.x"></button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button 
                        v-for="region in continents" 
                        :key="region"
                        @click="selectedRegion = region; showRegionSelector = false"
                        class="py-3 px-4 rounded-xl font-bold text-left transition-all flex justify-between items-center border-2"
                        :class="selectedRegion === region ? 'bg-blue-50 border-blue-500 text-blue-700' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'"
                    >
                        <span>{{ region }}</span>
                        <span v-if="selectedRegion === region" v-html="icons.check" class="text-blue-500 scale-75"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- START SCREEN -->
        <div v-if="screen === 'start'" class="flex flex-col items-center justify-center h-full p-6 text-center animate-fade-in">
            <div class="mb-8 animate-bounce-custom">
                <div class="w-32 h-24 bg-blue-500 rounded-lg shadow-lg flex items-center justify-center relative overflow-hidden border-4 border-blue-700 transform rotate-3">
                    <div class="absolute inset-0 flex flex-col">
                        <div class="h-1/3 bg-yellow-400"></div>
                        <div class="h-1/3 bg-blue-500"></div>
                        <div class="h-1/3 bg-red-500"></div>
                    </div>
                </div>
            </div>
            <h1 class="text-4xl font-extrabold text-gray-800 mb-4">Flag Master</h1>
            <p class="text-gray-500 text-lg mb-8 max-w-md">
                Master all {{ totalCountries }} flags of the world in one endless run!
            </p>
            
            <div v-if="highScore > 0" class="mb-8 bg-yellow-100 text-yellow-800 px-4 py-2 rounded-full font-bold inline-flex items-center shadow-sm">
                <span class="mr-2" v-html="icons.trophy"></span>
                Best Score: {{ highScore }}
            </div>

            <!-- Region Selector -->
            <button 
                @click="showRegionSelector = true"
                class="mb-6 px-5 py-2 bg-white border-2 border-gray-200 rounded-full text-gray-700 font-bold flex items-center shadow-sm hover:bg-gray-50 transition-colors no-select"
            >
                <span class="mr-2 text-blue-500" v-html="icons.globe"></span>
                Region: {{ selectedRegion }}
            </button>

            <div class="grid grid-cols-2 gap-4 w-full max-w-xs">
                <button @click="initGame('normal')" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-4 rounded-2xl border-b-4 border-green-700 active:border-b-0 active:translate-y-1 transition-all shadow-lg text-lg uppercase tracking-wide no-select">
                    Normal
                </button>
                <button @click="initGame('reverse')" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-4 px-4 rounded-2xl border-b-4 border-purple-700 active:border-b-0 active:translate-y-1 transition-all shadow-lg text-lg uppercase tracking-wide no-select">
                    Reverse
                </button>
                <button @click="initGame('blitz')" class="col-span-2 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-4 rounded-2xl border-b-4 border-red-700 active:border-b-0 active:translate-y-1 transition-all shadow-lg text-lg uppercase tracking-wide no-select flex items-center justify-center space-x-2">
                    <span v-html="icons.lightning"></span>
                    <span>Blitz Mode</span>
                </button>
            </div>
            
            <button @click="screen = 'passport'" class="mt-8 text-blue-500 font-bold flex items-center space-x-2 px-4 py-2 rounded-full hover:bg-blue-50 transition-colors">
                <span v-html="icons.book"></span>
                <span>My Passport</span>
            </button>
        </div>

        <!-- PASSPORT SCREEN -->
        <div v-if="screen === 'passport'" class="flex flex-col h-full bg-gray-50">
            <div class="bg-white shadow-sm px-4 py-4 z-10 flex items-center justify-between safe-top">
                <div class="flex items-center space-x-3">
                    <button @click="screen = 'start'" class="text-gray-500 hover:text-gray-700 bg-gray-100 p-2 rounded-full transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
                    </button>
                    <h2 class="text-xl font-bold text-gray-800">My Passport</h2>
                </div>
                <div class="text-sm font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full">
                    {{ Object.keys(collectedFlags).length }} / {{ totalCountries }}
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4">
                <!-- Region Stats -->
                <div class="grid grid-cols-2 gap-2 mb-6">
                    <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex flex-col items-center justify-center" v-for="region in continents.filter(c => c !== 'World')" :key="region">
                         <span class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-1">{{ region }}</span>
                         <span class="text-lg font-extrabold" :class="getRegionProgress(region) === 100 ? 'text-green-500' : 'text-gray-700'">
                            {{ getRegionCount(region) }}%
                         </span>
                         <div class="w-full h-1.5 bg-gray-100 rounded-full mt-2 overflow-hidden">
                            <div class="h-full bg-green-500 rounded-full" :style="{ width: getRegionProgress(region) + '%' }"></div>
                         </div>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-3 pb-8">
                    <div 
                        v-for="country in COUNTRIES" 
                        :key="country.code"
                        class="aspect-square rounded-xl flex items-center justify-center relative overflow-hidden border-2 transition-all"
                        :class="collectedFlags[country.code] ? 'bg-white border-blue-200 shadow-sm' : 'bg-gray-100 border-gray-200 opacity-60'"
                    >
                        <img 
                            v-if="collectedFlags[country.code]"
                            :src="`https://flagcdn.com/w160/${country.code}.png`" 
                            loading="lazy"
                            class="w-full h-full object-cover"
                            :alt="country.name"
                        >
                        <span v-else class="text-2xl text-gray-300">?</span>
                        
                        <!-- Count Badge -->
                        <div v-if="collectedFlags[country.code] > 1" class="absolute bottom-0 right-0 bg-blue-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-tl-lg">
                            {{ collectedFlags[country.code] }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PLAYING SCREEN -->
        <div v-if="screen === 'playing'" class="flex flex-col h-full relative">
            <!-- Header -->
            <div class="pt-6 pb-2 px-4 flex flex-col bg-white z-10 safe-top">
                <div class="flex items-center justify-between w-full">
                    <button @click="reloadPage" class="text-gray-400 hover:text-gray-600 no-select" v-html="icons.x"></button>
                    <div class="flex-1 mx-4">
                        <div class="w-full h-4 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-green-500 transition-all duration-500 ease-out rounded-full" :style="{ width: progress + '%' }"></div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-1">
                        <span v-html="lives > 0 ? icons.heartFilled : icons.heart"></span>
                        <span class="text-xl font-bold text-red-500">{{ lives }}</span>
                    </div>
                </div>
                
                <!-- Blitz Timer -->
                <div v-if="gameMode === 'blitz'" class="w-full mt-3">
                    <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden shadow-inner">
                        <div class="h-full transition-all duration-100 ease-linear" 
                             :class="timeLeft < 2 ? 'bg-red-600 animate-pulse' : 'bg-orange-500'"
                             :style="{ width: (timeLeft / 5) * 100 + '%' }"></div>
                    </div>
                </div>
            </div>

            <!-- Game Board -->
            <div class="flex-1 overflow-y-auto p-4 flex flex-col items-center w-full pb-32">
                <h2 class="text-2xl font-bold text-gray-700 mt-4 mb-6 text-left w-full">
                    {{ gameMode === 'reverse' ? 'Which flag is this?' : 'Which country is this?' }}
                </h2>

                <div class="mb-6 p-4 bg-white rounded-2xl shadow-sm border-2 border-gray-100 w-full flex justify-center items-center min-h-[160px]">
                    <img 
                        v-if="currentQuestion && gameMode !== 'reverse'"
                        :src="`https://flagcdn.com/w640/${currentQuestion.correctOption.code}.png`" 
                        alt="Flag" 
                        class="h-40 w-auto rounded-md shadow-md object-cover border border-gray-200"
                        @error="handleImageError"
                    >
                    <h3 v-if="currentQuestion && gameMode === 'reverse'" class="text-3xl font-extrabold text-gray-800 text-center">
                        {{ currentQuestion.correctOption.name }}
                    </h3>
                </div>

                <div class="grid w-full" :class="gameMode === 'reverse' ? 'grid-cols-2 gap-4' : 'grid-cols-1 gap-3'" v-if="currentQuestion">
                    <button 
                        v-for="(option, idx) in currentQuestion.options" 
                        :key="option.code"
                        @click="handleAnswer(option)"
                        class="relative w-full rounded-2xl border-2 border-b-4 font-bold transition-all flex items-center justify-between group no-select"
                        :class="[
                            getOptionClass(option),
                            gameMode === 'reverse' ? 'p-2 h-32 flex-col justify-center' : 'p-4 text-lg'
                        ]"
                        :disabled="feedback !== null"
                    >
                        <div class="flex items-center" :class="{'w-full justify-center': gameMode === 'reverse'}">
                            <span 
                                class="flex items-center justify-center w-8 h-8 rounded-lg text-sm border absolute top-2 left-2"
                                :class="getNumberClass(option)"
                                v-if="gameMode === 'reverse'"
                            >
                                {{ idx + 1 }}
                            </span>
                            <span 
                                class="flex items-center justify-center w-8 h-8 rounded-lg text-sm border mr-3"
                                :class="getNumberClass(option)"
                                v-else
                            >
                                {{ idx + 1 }}
                            </span>
                            
                            <span v-if="gameMode !== 'reverse'">{{ option.name }}</span>
                            <img 
                                v-if="gameMode === 'reverse'"
                                :src="`https://flagcdn.com/w320/${option.code}.png`" 
                                alt="Flag" 
                                class="h-20 w-auto rounded shadow-sm object-cover"
                                @error="handleImageError"
                            >
                        </div>
                    </button>
                </div>
            </div>

            <!-- Bottom Sheet -->
            <div 
                class="fixed bottom-0 left-0 right-0 max-w-md mx-auto sheet-transition p-4 border-t-2 flex flex-col z-50 shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.3)]"
                :class="bottomSheetClasses"
            >
                <div class="flex items-center justify-between mb-4 px-2">
                    <div class="flex items-center space-x-3">
                        <div 
                            class="p-2 rounded-full text-white"
                            :class="isCorrect ? 'bg-green-500' : 'bg-red-500'"
                        >
                            <span v-html="isCorrect ? icons.check : icons.x"></span>
                        </div>
                        <div>
                            <h3 
                                class="text-xl font-extrabold"
                                :class="isCorrect ? 'text-green-600' : 'text-red-600'"
                            >
                                {{ isCorrect ? 'Excellent!' : (feedback === 'timeout' ? "Time's Up!" : 'Incorrect') }}
                            </h3>
                            <p v-if="!isCorrect" class="text-red-500 font-medium">
                                Correct: {{ currentQuestion?.correctOption.name }}
                            </p>
                        </div>
                    </div>
                </div>
                <button 
                    @click="nextQuestion" 
                    class="w-full py-3 px-6 rounded-xl font-bold text-white text-lg uppercase tracking-wider border-b-4 active:border-b-0 active:translate-y-1 transition-all shadow-md no-select"
                    :class="isCorrect ? 'bg-green-500 hover:bg-green-600 border-green-700' : 'bg-red-500 hover:bg-red-600 border-red-700'"
                >
                    Continue
                </button>
                <div class="h-4 md:h-0"></div>
            </div>

            <!-- Desktop Hint -->
            <div class="hidden md:block fixed bottom-4 right-4 text-xs text-gray-400 bg-white p-2 rounded border shadow-sm">
                Press <strong>1-4</strong> to answer, <strong>Enter</strong> to continue
            </div>
        </div>

        <!-- END SCREEN -->
        <div v-if="screen === 'end'" class="flex flex-col items-center justify-center h-full p-6 text-center">
            <div class="mb-6">
                <div class="w-32 h-32 mx-auto" :class="lives > 0 ? 'text-yellow-400' : 'text-gray-300'">
                    <span v-html="lives > 0 ? icons.trophyLarge : icons.heartLarge"></span>
                </div>
            </div>
            
            <h2 class="text-3xl font-extrabold text-gray-800 mb-2">
                {{ lives > 0 ? 'World Master!' : 'Out of Hearts!' }}
            </h2>
            
            <div class="bg-gray-100 p-6 rounded-2xl w-full max-w-sm mb-8 border-2 border-gray-200">
                <div class="flex justify-between items-center mb-4 border-b pb-4 border-gray-300">
                    <span class="text-gray-600 font-bold">Total Score</span>
                    <span class="text-2xl font-extrabold text-blue-500">{{ score }}</span>
                </div>
                <div class="flex justify-between items-center mb-4 border-b pb-4 border-gray-300" v-if="highScore > 0">
                    <span class="text-gray-600 font-bold">Best Score</span>
                    <div class="flex items-center">
                        <span v-if="score >= highScore && score > 0" class="mr-2 text-xs bg-yellow-400 text-white px-2 py-1 rounded-full font-bold animate-pulse">NEW!</span>
                        <span class="text-2xl font-extrabold text-yellow-600">{{ highScore }}</span>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600 font-bold">Flags Identified</span>
                    <span class="text-xl font-extrabold text-green-500">{{ currentIndex }}/{{ queue.length }}</span>
                </div>
            </div>

            <button @click="screen = 'start'" class="w-full max-w-xs bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-2xl border-b-4 border-blue-700 active:border-b-0 active:translate-y-1 transition-all shadow-lg text-lg uppercase tracking-wide flex items-center justify-center space-x-2 no-select">
                <span class="mr-2" v-html="icons.rotateCcw"></span>
                <span>Try Again</span>
            </button>

            <button @click="shareScore" class="mt-4 w-full max-w-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-3 px-8 rounded-2xl border-b-4 border-yellow-600 active:border-b-0 active:translate-y-1 transition-all shadow-md text-lg uppercase tracking-wide flex items-center justify-center space-x-2 no-select">
                <span class="mr-2" v-html="icons.share"></span>
                <span>Share Score</span>
            </button>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted } = Vue;

        // --- DATA ---
        const COUNTRIES = [
            { code: 'ad', name: 'Andorra', continent: 'Europe' }, { code: 'ae', name: 'United Arab Emirates', continent: 'Asia' }, { code: 'af', name: 'Afghanistan', continent: 'Asia' }, 
            { code: 'ag', name: 'Antigua and Barbuda', continent: 'North America' }, { code: 'al', name: 'Albania', continent: 'Europe' }, { code: 'am', name: 'Armenia', continent: 'Asia' }, 
            { code: 'ao', name: 'Angola', continent: 'Africa' }, { code: 'ar', name: 'Argentina', continent: 'South America' }, { code: 'at', name: 'Austria', continent: 'Europe' }, 
            { code: 'au', name: 'Australia', continent: 'Oceania' }, { code: 'az', name: 'Azerbaijan', continent: 'Asia' }, { code: 'ba', name: 'Bosnia and Herzegovina', continent: 'Europe' }, 
            { code: 'bb', name: 'Barbados', continent: 'North America' }, { code: 'bd', name: 'Bangladesh', continent: 'Asia' }, { code: 'be', name: 'Belgium', continent: 'Europe' }, 
            { code: 'bf', name: 'Burkina Faso', continent: 'Africa' }, { code: 'bg', name: 'Bulgaria', continent: 'Europe' }, { code: 'bh', name: 'Bahrain', continent: 'Asia' }, 
            { code: 'bi', name: 'Burundi', continent: 'Africa' }, { code: 'bj', name: 'Benin', continent: 'Africa' }, { code: 'bn', name: 'Brunei', continent: 'Asia' }, 
            { code: 'bo', name: 'Bolivia', continent: 'South America' }, { code: 'br', name: 'Brazil', continent: 'South America' }, { code: 'bs', name: 'Bahamas', continent: 'North America' }, 
            { code: 'bt', name: 'Bhutan', continent: 'Asia' }, { code: 'bw', name: 'Botswana', continent: 'Africa' }, { code: 'by', name: 'Belarus', continent: 'Europe' }, 
            { code: 'bz', name: 'Belize', continent: 'North America' }, { code: 'ca', name: 'Canada', continent: 'North America' }, { code: 'cd', name: 'DR Congo', continent: 'Africa' }, 
            { code: 'cf', name: 'Central African Republic', continent: 'Africa' }, { code: 'cg', name: 'Congo', continent: 'Africa' }, { code: 'ch', name: 'Switzerland', continent: 'Europe' }, 
            { code: 'ci', name: 'Ivory Coast', continent: 'Africa' }, { code: 'cl', name: 'Chile', continent: 'South America' }, { code: 'cm', name: 'Cameroon', continent: 'Africa' }, 
            { code: 'cn', name: 'China', continent: 'Asia' }, { code: 'co', name: 'Colombia', continent: 'South America' }, { code: 'cr', name: 'Costa Rica', continent: 'North America' }, 
            { code: 'cu', name: 'Cuba', continent: 'North America' }, { code: 'cv', name: 'Cape Verde', continent: 'Africa' }, { code: 'cy', name: 'Cyprus', continent: 'Europe' }, 
            { code: 'cz', name: 'Czechia', continent: 'Europe' }, { code: 'de', name: 'Germany', continent: 'Europe' }, { code: 'dj', name: 'Djibouti', continent: 'Africa' }, 
            { code: 'dk', name: 'Denmark', continent: 'Europe' }, { code: 'dm', name: 'Dominica', continent: 'North America' }, { code: 'do', name: 'Dominican Republic', continent: 'North America' }, 
            { code: 'dz', name: 'Algeria', continent: 'Africa' }, { code: 'ec', name: 'Ecuador', continent: 'South America' }, { code: 'ee', name: 'Estonia', continent: 'Europe' }, 
            { code: 'eg', name: 'Egypt', continent: 'Africa' }, { code: 'er', name: 'Eritrea', continent: 'Africa' }, { code: 'es', name: 'Spain', continent: 'Europe' }, 
            { code: 'et', name: 'Ethiopia', continent: 'Africa' }, { code: 'fi', name: 'Finland', continent: 'Europe' }, { code: 'fj', name: 'Fiji', continent: 'Oceania' }, 
            { code: 'fm', name: 'Micronesia', continent: 'Oceania' }, { code: 'fr', name: 'France', continent: 'Europe' }, { code: 'ga', name: 'Gabon', continent: 'Africa' }, 
            { code: 'gb', name: 'United Kingdom', continent: 'Europe' }, { code: 'gd', name: 'Grenada', continent: 'North America' }, { code: 'ge', name: 'Georgia', continent: 'Asia' }, 
            { code: 'gh', name: 'Ghana', continent: 'Africa' }, { code: 'gm', name: 'Gambia', continent: 'Africa' }, { code: 'gn', name: 'Guinea', continent: 'Africa' }, 
            { code: 'gq', name: 'Equatorial Guinea', continent: 'Africa' }, { code: 'gr', name: 'Greece', continent: 'Europe' }, { code: 'gt', name: 'Guatemala', continent: 'North America' }, 
            { code: 'gw', name: 'Guinea-Bissau', continent: 'Africa' }, { code: 'gy', name: 'Guyana', continent: 'South America' }, { code: 'hn', name: 'Honduras', continent: 'North America' }, 
            { code: 'hr', name: 'Croatia', continent: 'Europe' }, { code: 'ht', name: 'Haiti', continent: 'North America' }, { code: 'hu', name: 'Hungary', continent: 'Europe' }, 
            { code: 'id', name: 'Indonesia', continent: 'Asia' }, { code: 'ie', name: 'Ireland', continent: 'Europe' }, { code: 'il', name: 'Israel', continent: 'Asia' }, 
            { code: 'in', name: 'India', continent: 'Asia' }, { code: 'iq', name: 'Iraq', continent: 'Asia' }, { code: 'ir', name: 'Iran', continent: 'Asia' }, 
            { code: 'is', name: 'Iceland', continent: 'Europe' }, { code: 'it', name: 'Italy', continent: 'Europe' }, { code: 'jm', name: 'Jamaica', continent: 'North America' }, 
            { code: 'jo', name: 'Jordan', continent: 'Asia' }, { code: 'jp', name: 'Japan', continent: 'Asia' }, { code: 'ke', name: 'Kenya', continent: 'Africa' }, 
            { code: 'kg', name: 'Kyrgyzstan', continent: 'Asia' }, { code: 'kh', name: 'Cambodia', continent: 'Asia' }, { code: 'ki', name: 'Kiribati', continent: 'Oceania' }, 
            { code: 'km', name: 'Comoros', continent: 'Africa' }, { code: 'kn', name: 'Saint Kitts and Nevis', continent: 'North America' }, { code: 'kp', name: 'North Korea', continent: 'Asia' }, 
            { code: 'kr', name: 'South Korea', continent: 'Asia' }, { code: 'kw', name: 'Kuwait', continent: 'Asia' }, { code: 'kz', name: 'Kazakhstan', continent: 'Asia' }, 
            { code: 'la', name: 'Laos', continent: 'Asia' }, { code: 'lb', name: 'Lebanon', continent: 'Asia' }, { code: 'lc', name: 'Saint Lucia', continent: 'North America' }, 
            { code: 'li', name: 'Liechtenstein', continent: 'Europe' }, { code: 'lk', name: 'Sri Lanka', continent: 'Asia' }, { code: 'lr', name: 'Liberia', continent: 'Africa' }, 
            { code: 'ls', name: 'Lesotho', continent: 'Africa' }, { code: 'lt', name: 'Lithuania', continent: 'Europe' }, { code: 'lu', name: 'Luxembourg', continent: 'Europe' }, 
            { code: 'lv', name: 'Latvia', continent: 'Europe' }, { code: 'ly', name: 'Libya', continent: 'Africa' }, { code: 'ma', name: 'Morocco', continent: 'Africa' }, 
            { code: 'mc', name: 'Monaco', continent: 'Europe' }, { code: 'md', name: 'Moldova', continent: 'Europe' }, { code: 'me', name: 'Montenegro', continent: 'Europe' }, 
            { code: 'mg', name: 'Madagascar', continent: 'Africa' }, { code: 'mh', name: 'Marshall Islands', continent: 'Oceania' }, { code: 'mk', name: 'North Macedonia', continent: 'Europe' }, 
            { code: 'ml', name: 'Mali', continent: 'Africa' }, { code: 'mm', name: 'Myanmar', continent: 'Asia' }, { code: 'mn', name: 'Mongolia', continent: 'Asia' }, 
            { code: 'mr', name: 'Mauritania', continent: 'Africa' }, { code: 'mt', name: 'Malta', continent: 'Europe' }, { code: 'mu', name: 'Mauritius', continent: 'Africa' }, 
            { code: 'mv', name: 'Maldives', continent: 'Asia' }, { code: 'mw', name: 'Malawi', continent: 'Africa' }, { code: 'mx', name: 'Mexico', continent: 'North America' }, 
            { code: 'my', name: 'Malaysia', continent: 'Asia' }, { code: 'mz', name: 'Mozambique', continent: 'Africa' }, { code: 'na', name: 'Namibia', continent: 'Africa' }, 
            { code: 'ne', name: 'Niger', continent: 'Africa' }, { code: 'ng', name: 'Nigeria', continent: 'Africa' }, { code: 'ni', name: 'Nicaragua', continent: 'North America' }, 
            { code: 'nl', name: 'Netherlands', continent: 'Europe' }, { code: 'no', name: 'Norway', continent: 'Europe' }, { code: 'np', name: 'Nepal', continent: 'Asia' }, 
            { code: 'nr', name: 'Nauru', continent: 'Oceania' }, { code: 'nz', name: 'New Zealand', continent: 'Oceania' }, { code: 'om', name: 'Oman', continent: 'Asia' }, 
            { code: 'pa', name: 'Panama', continent: 'North America' }, { code: 'pe', name: 'Peru', continent: 'South America' }, { code: 'pg', name: 'Papua New Guinea', continent: 'Oceania' }, 
            { code: 'ph', name: 'Philippines', continent: 'Asia' }, { code: 'pk', name: 'Pakistan', continent: 'Asia' }, { code: 'pl', name: 'Poland', continent: 'Europe' }, 
            { code: 'pt', name: 'Portugal', continent: 'Europe' }, { code: 'pw', name: 'Palau', continent: 'Oceania' }, { code: 'py', name: 'Paraguay', continent: 'South America' }, 
            { code: 'qa', name: 'Qatar', continent: 'Asia' }, { code: 'ro', name: 'Romania', continent: 'Europe' }, { code: 'rs', name: 'Serbia', continent: 'Europe' }, 
            { code: 'ru', name: 'Russia', continent: 'Europe' }, { code: 'rw', name: 'Rwanda', continent: 'Africa' }, { code: 'sa', name: 'Saudi Arabia', continent: 'Asia' }, 
            { code: 'sb', name: 'Solomon Islands', continent: 'Oceania' }, { code: 'sc', name: 'Seychelles', continent: 'Africa' }, { code: 'sd', name: 'Sudan', continent: 'Africa' }, 
            { code: 'se', name: 'Sweden', continent: 'Europe' }, { code: 'sg', name: 'Singapore', continent: 'Asia' }, { code: 'si', name: 'Slovenia', continent: 'Europe' }, 
            { code: 'sk', name: 'Slovakia', continent: 'Europe' }, { code: 'sl', name: 'Sierra Leone', continent: 'Africa' }, { code: 'sm', name: 'San Marino', continent: 'Europe' }, 
            { code: 'sn', name: 'Senegal', continent: 'Africa' }, { code: 'so', name: 'Somalia', continent: 'Africa' }, { code: 'sr', name: 'Suriname', continent: 'South America' }, 
            { code: 'ss', name: 'South Sudan', continent: 'Africa' }, { code: 'st', name: 'Sao Tome and Principe', continent: 'Africa' }, { code: 'sv', name: 'El Salvador', continent: 'North America' }, 
            { code: 'sy', name: 'Syria', continent: 'Asia' }, { code: 'sz', name: 'Eswatini', continent: 'Africa' }, { code: 'td', name: 'Chad', continent: 'Africa' }, 
            { code: 'tg', name: 'Togo', continent: 'Africa' }, { code: 'th', name: 'Thailand', continent: 'Asia' }, { code: 'tj', name: 'Tajikistan', continent: 'Asia' }, 
            { code: 'tl', name: 'Timor-Leste', continent: 'Asia' }, { code: 'tm', name: 'Turkmenistan', continent: 'Asia' }, { code: 'tn', name: 'Tunisia', continent: 'Africa' }, 
            { code: 'to', name: 'Tonga', continent: 'Oceania' }, { code: 'tr', name: 'Turkey', continent: 'Asia' }, { code: 'tt', name: 'Trinidad and Tobago', continent: 'North America' }, 
            { code: 'tv', name: 'Tuvalu', continent: 'Oceania' }, { code: 'tw', name: 'Taiwan', continent: 'Asia' }, { code: 'tz', name: 'Tanzania', continent: 'Africa' }, 
            { code: 'ua', name: 'Ukraine', continent: 'Europe' }, { code: 'ug', name: 'Uganda', continent: 'Africa' }, { code: 'us', name: 'United States', continent: 'North America' }, 
            { code: 'uy', name: 'Uruguay', continent: 'South America' }, { code: 'uz', name: 'Uzbekistan', continent: 'Asia' }, { code: 'va', name: 'Vatican City', continent: 'Europe' }, 
            { code: 'vc', name: 'Saint Vincent and the Grenadines', continent: 'North America' }, { code: 've', name: 'Venezuela', continent: 'South America' }, { code: 'vn', name: 'Vietnam', continent: 'Asia' }, 
            { code: 'vu', name: 'Vanuatu', continent: 'Oceania' }, { code: 'ws', name: 'Samoa', continent: 'Oceania' }, { code: 'ye', name: 'Yemen', continent: 'Asia' }, { code: 'za', name: 'South Africa', continent: 'Africa' }, 
            { code: 'zm', name: 'Zambia', continent: 'Africa' }, { code: 'zw', name: 'Zimbabwe', continent: 'Africa' }
        ];

        const ICONS = {
            heart: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>`,
            heartFilled: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>`,
            trophy: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
            trophyLarge: `<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
            heartLarge: `<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>`,
            x: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
            check: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`,
            rotateCcw: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/></svg>`,
            share: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>`,
            lightning: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
            book: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>`,
            globe: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>`
        };

        createApp({
            setup() {
                // State
                const screen = ref('start'); // start, playing, end
                const gameMode = ref('normal'); // normal, reverse, blitz
                const score = ref(0);
                const lives = ref(3);
                const streak = ref(0);
                const highScore = ref(0);
                const queue = ref([]);
                const currentIndex = ref(0);
                const currentQuestion = ref(null);
                const selectedOption = ref(null);
                const feedback = ref(null); // 'correct', 'incorrect', 'timeout', null
                const lastFeedback = ref(null); // To persist feedback during transition
                const hasCelebratedHighScore = ref(false);
                
                // Passport / Collection State
                const collectedFlags = ref({}); // { 'us': 1, 'fr': 3 } - counts of correct answers

                // Region Filter
                const selectedRegion = ref('World');
                const showRegionSelector = ref(false);
                const continents = ['World', 'Africa', 'Asia', 'Europe', 'North America', 'Oceania', 'South America'];
                
                // Timer State (Blitz Mode)
                const timerInterval = ref(null);
                const timeLeft = ref(0);
                const BLITZ_TIME = 5; // seconds
                const autoAdvanceTimer = ref(null);
                
                let audioContext = null;

                // Logic
                const shuffleArray = (array) => {
                    const newArray = [...array];
                    for (let i = newArray.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                    }
                    return newArray;
                };

                const generateQuestion = () => {
                    const correctOption = queue.value[currentIndex.value];
                    
                    // Pick 3 distractors
                    const distractors = [];
                    // Filter available distractors to match the current region as well
                    let availableDistractors = COUNTRIES.filter(c => c.code !== correctOption.code);
                    if (selectedRegion.value !== 'World') {
                        availableDistractors = availableDistractors.filter(c => c.continent === selectedRegion.value);
                    }
                    
                    // If we don't have enough distractors (rare, but possible in very small regions if we added any), fallback to world
                    if (availableDistractors.length < 3) {
                         availableDistractors = COUNTRIES.filter(c => c.code !== correctOption.code);
                    }
                    
                    while (distractors.length < 3) {
                        const randomIndex = Math.floor(Math.random() * availableDistractors.length);
                        const randomDistractor = availableDistractors[randomIndex];
                        if (!distractors.includes(randomDistractor)) {
                            distractors.push(randomDistractor);
                        }
                    }
                    
                    const options = shuffleArray([correctOption, ...distractors]);
                    
                    return { correctOption, options };
                };

                const initAudio = () => {
                    if (!audioContext) {
                        const AudioContext = window.AudioContext || window.webkitAudioContext;
                        if (AudioContext) {
                            audioContext = new AudioContext();
                        }
                    }
                    if (audioContext && audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                };

                // Timer Logic
                const startTimer = () => {
                    if (gameMode.value !== 'blitz') return;
                    
                    clearInterval(timerInterval.value);
                    timeLeft.value = BLITZ_TIME;
                    
                    timerInterval.value = setInterval(() => {
                        timeLeft.value -= 0.05; // Update every 50ms
                        if (timeLeft.value <= 0) {
                            timeLeft.value = 0;
                            clearInterval(timerInterval.value);
                            handleTimeUp();
                        }
                    }, 50);
                };

                const handleTimeUp = () => {
                    if (feedback.value !== null) return;
                    
                    feedback.value = 'timeout';
                    lastFeedback.value = 'timeout';
                    lives.value = 0; // Instant death in blitz
                    streak.value = 0;
                    
                    playSound('incorrect');
                    triggerHaptic('incorrect');
                };

                const initGame = (mode = 'normal') => {
                    initAudio();
                    gameMode.value = mode;
                    score.value = 0;
                    lives.value = mode === 'blitz' ? 1 : 3;
                    streak.value = 0;
                    hasCelebratedHighScore.value = false;
                    
                    // Filter Countries
                    let filteredCountries = COUNTRIES;
                    if (selectedRegion.value !== 'World') {
                        filteredCountries = COUNTRIES.filter(c => c.continent === selectedRegion.value);
                    }
                    
                    queue.value = shuffleArray(filteredCountries);
                    currentIndex.value = 0;
                    selectedOption.value = null;
                    feedback.value = null;
                    lastFeedback.value = null;
                    currentQuestion.value = generateQuestion();
                    screen.value = 'playing';

                    if (mode === 'blitz') {
                        startTimer();
                    }
                };

                // Audio Logic
                const playSound = (type) => {
                    if (!audioContext) return;
                    
                    const ctx = audioContext;
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    
                    if (type === 'correct') {
                        // High pitched "ding"
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(523.25, ctx.currentTime); // C5
                        osc.frequency.exponentialRampToValueAtTime(1046.5, ctx.currentTime + 0.1); // C6
                        gain.gain.setValueAtTime(0.3, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                        osc.start(ctx.currentTime);
                        osc.stop(ctx.currentTime + 0.3);
                    } else if (type === 'incorrect') {
                        // Low pitched "buzz"
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(150, ctx.currentTime);
                        osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.2);
                        gain.gain.setValueAtTime(0.3, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                        osc.start(ctx.currentTime);
                        osc.stop(ctx.currentTime + 0.3);
                    }
                };

                // Haptic Feedback
                const triggerHaptic = (type) => {
                    if (navigator.vibrate) {
                        if (type === 'correct') {
                            navigator.vibrate([50]); // Short light tap
                        } else if (type === 'incorrect') {
                            navigator.vibrate([100, 50, 100]); // Double buzz
                        }
                    }
                };

                // Confetti Logic
                const triggerConfetti = () => {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                };

                const triggerEmojiRain = () => {
                    const emojis = ['üåç', 'üåé', 'üåè', 'üó∫Ô∏è', 'üö©', 'üéå', 'üè≥Ô∏è'];
                    const end = Date.now() + 1000;
                    
                    (function frame() {
                        confetti({
                            particleCount: 3,
                            angle: 60,
                            spread: 55,
                            origin: { x: 0 },
                            shapes: ['circle'],
                            scalar: 2,
                            contents: emojis
                        });
                        confetti({
                            particleCount: 3,
                            angle: 120,
                            spread: 55,
                            origin: { x: 1 },
                            shapes: ['circle'],
                            scalar: 2,
                            contents: emojis
                        });

                        if (Date.now() < end) {
                            requestAnimationFrame(frame);
                        }
                    }());
                };

                const triggerFireworks = () => {
                    const duration = 1000;
                    const animationEnd = Date.now() + duration;
                    const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

                    const randomInRange = (min, max) => Math.random() * (max - min) + min;

                    const interval = setInterval(function() {
                        const timeLeft = animationEnd - Date.now();

                        if (timeLeft <= 0) {
                            return clearInterval(interval);
                        }

                        const particleCount = 50 * (timeLeft / duration);
                        confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                        confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
                    }, 250);
                };

                const triggerSchoolPride = () => {
                    const end = Date.now() + 1000;
                    const colors = ['#bb0000', '#ffffff'];

                    (function frame() {
                        confetti({
                            particleCount: 2,
                            angle: 60,
                            spread: 55,
                            origin: { x: 0 },
                            colors: colors
                        });
                        confetti({
                            particleCount: 2,
                            angle: 120,
                            spread: 55,
                            origin: { x: 1 },
                            colors: colors
                        });

                        if (Date.now() < end) {
                            requestAnimationFrame(frame);
                        }
                    }());
                };
                
                const triggerPride = () => {
                    const colors = ['#FF0018', '#FFA52C', '#FFFF41', '#008018', '#0000F9', '#86007D'];
                    confetti({
                        particleCount: 150,
                        spread: 100,
                        origin: { y: 0.6 },
                        colors: colors,
                        disableForReducedMotion: true
                    });
                };

                const triggerCelebration = () => {
                    const celebrations = [triggerConfetti, triggerFireworks, triggerSchoolPride, triggerPride];
                    const randomCelebration = celebrations[Math.floor(Math.random() * celebrations.length)];
                    randomCelebration();
                };

                const handleAnswer = (option) => {
                    if (feedback.value !== null) return; // Already answered

                    clearInterval(timerInterval.value);
                    
                    selectedOption.value = option;
                    const isCorrect = option.code === currentQuestion.value.correctOption.code;

                    if (isCorrect) {
                        feedback.value = 'correct';
                        lastFeedback.value = 'correct';
                        score.value += 10 + (streak.value * 2);
                        streak.value += 1;
                        
                        // Sound & Haptics
                        playSound('correct');
                        triggerHaptic('correct');
                        
                        // Update High Score
                        let beatHighScore = false;
                        // Only confetti if we actually beat a *previous* high score that was > 0
                        if (score.value > highScore.value) {
                            const previousHigh = highScore.value;
                            highScore.value = score.value;
                            localStorage.setItem('flag-master-highscore', highScore.value);

                            if (previousHigh > 0 && !hasCelebratedHighScore.value) {
                                beatHighScore = true;
                                hasCelebratedHighScore.value = true;
                            }
                        }
                        
                        // Update Passport
                        if (!collectedFlags.value[option.code]) {
                            collectedFlags.value[option.code] = 0;
                        }
                        collectedFlags.value[option.code]++;
                        localStorage.setItem('flag-master-collection', JSON.stringify(collectedFlags.value));

                        if (beatHighScore) {
                            // Confetti for NEW High Score (First time only this run, if beating a non-zero record)
                            triggerCelebration();
                        } else if (streak.value > 0 && streak.value % 5 === 0) {
                            // Confetti every 5 streak
                            triggerCelebration();
                        }

                        if (gameMode.value === 'blitz') {
                            autoAdvanceTimer.value = setTimeout(() => {
                                nextQuestion();
                            }, 600);
                        }
                    } else {
                        feedback.value = 'incorrect';
                        lastFeedback.value = 'incorrect';
                        lives.value -= 1;
                        streak.value = 0;

                        // Sound & Haptics
                        playSound('incorrect');
                        triggerHaptic('incorrect');
                    }
                };

                const nextQuestion = () => {
                    if (autoAdvanceTimer.value) {
                        clearTimeout(autoAdvanceTimer.value);
                        autoAdvanceTimer.value = null;
                    }

                    if (lives.value <= 0) {
                        screen.value = 'end';
                    } else if (currentIndex.value >= queue.value.length - 1) {
                        screen.value = 'end';
                    } else {
                        currentIndex.value += 1;
                        currentQuestion.value = generateQuestion();
                        selectedOption.value = null;
                        feedback.value = null;
                        if (gameMode.value === 'blitz') {
                            startTimer();
                        }
                    }
                };

                const reloadPage = () => {
                    location.reload();
                };

                const handleImageError = (e) => {
                    e.target.onerror = null;
                    e.target.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
                };

                const shareScore = async () => {
                    const text = `I scored ${score.value} points in Flag Master! üè≥Ô∏è Can you beat me?`;
                    const url = window.location.href;
                    
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: `üèÜ Flag Master Score: ${score.value}`,
                                text: text,
                                url: url
                            });
                        } catch (err) {
                            console.log('Share cancelled or failed', err);
                        }
                    } else {
                        try {
                            await navigator.clipboard.writeText(`${text} ${url}`);
                            alert('Score copied to clipboard!');
                        } catch (err) {
                            console.error('Failed to copy: ', err);
                        }
                    }
                };

                // Computed
                const progress = computed(() => ((currentIndex.value) / queue.value.length) * 100);
                const isCorrect = computed(() => {
                    if (feedback.value !== null) {
                        return feedback.value === 'correct';
                    }
                    return lastFeedback.value === 'correct';
                });
                const totalCountries = computed(() => COUNTRIES.length);

                // Dynamic Classes
                const getOptionClass = (option) => {
                    let classes = '';
                    if (feedback.value !== null) {
                        if (option.code === currentQuestion.value.correctOption.code) {
                            classes = "bg-green-100 border-green-500 text-green-700";
                        } else if (selectedOption.value && selectedOption.value.code === option.code) {
                            classes = "bg-red-100 border-red-500 text-red-700";
                        } else {
                            classes = "bg-white border-gray-200 opacity-50 text-gray-400";
                        }
                    } else {
                        if (selectedOption.value === option) {
                            classes = "bg-blue-100 border-blue-500 text-blue-700";
                        } else {
                            classes = "bg-white border-gray-200 hover:bg-gray-50 text-gray-700 active:border-b-2 active:translate-y-[2px]";
                        }
                    }
                    return classes;
                };

                const getNumberClass = (option) => {
                    if (feedback.value !== null) {
                        if (option.code === currentQuestion.value.correctOption.code) {
                            return "border-green-500 text-green-700 bg-green-200";
                        } else if (selectedOption.value && selectedOption.value.code === option.code) {
                            return "border-red-500 text-red-700 bg-red-200";
                        } else {
                            return "border-gray-200 bg-white";
                        }
                    } else {
                        if (selectedOption.value === option) {
                            return "border-blue-500 text-blue-700 bg-blue-200";
                        } else {
                            return "border-gray-200 text-gray-400 bg-white";
                        }
                    }
                };

                const bottomSheetClasses = computed(() => {
                    let classes = isCorrect.value ? "bg-green-100 border-green-200" : "bg-red-100 border-red-200";
                    if (feedback.value === null) {
                        classes += " translate-y-full";
                    } else {
                        classes += " translate-y-0";
                    }
                    return classes;
                });

                // Keyboard Events
                const handleKeydown = (e) => {
                    if (screen.value === 'playing') {
                        if (['1', '2', '3', '4'].includes(e.key) && feedback.value === null) {
                            const index = parseInt(e.key) - 1;
                            if (currentQuestion.value && currentQuestion.value.options[index]) {
                                handleAnswer(currentQuestion.value.options[index]);
                            }
                        }
                        if (e.key === 'Enter' && feedback.value !== null) {
                            nextQuestion();
                        }
                    } else if (screen.value === 'start') {
                        if (e.key === 'Enter') {
                            initGame('normal');
                        }
                    } else if (screen.value === 'end') {
                        if (e.key === 'Enter') {
                            screen.value = 'start';
                        }
                    }
                };

                // Prevent Zoom
                const handleGestureStart = (e) => {
                    e.preventDefault();
                }

                onMounted(() => {
                    
                    window.addEventListener('keydown', handleKeydown);
                    document.addEventListener('gesturestart', handleGestureStart);
                    
                    // Load High Score
                    const savedScore = localStorage.getItem('flag-master-highscore');
                    if (savedScore) {
                        highScore.value = parseInt(savedScore);
                    }
                    
                    // Load Passport
                    const savedCollection = localStorage.getItem('flag-master-collection');
                    if (savedCollection) {
                        try {
                            collectedFlags.value = JSON.parse(savedCollection);
                        } catch (e) {
                            console.error('Failed to load collection', e);
                            collectedFlags.value = {};
                        }
                    }
                });

                onUnmounted(() => {
                    clearInterval(timerInterval.value);
                    if (autoAdvanceTimer.value) clearTimeout(autoAdvanceTimer.value);
                    window.removeEventListener('keydown', handleKeydown);
                    document.removeEventListener('gesturestart', handleGestureStart);
                });

                return {
                    screen,
                    gameMode,
                    score,
                    lives,
                    highScore,
                    currentIndex,
                    currentQuestion,
                    selectedOption,
                    feedback,
                    initGame,
                    handleAnswer,
                    nextQuestion,
                    reloadPage,
                    handleImageError,
                    shareScore,
                    progress,
                    isCorrect,
                    totalCountries,
                    getOptionClass,
                    getNumberClass,
                    bottomSheetClasses,
                    timeLeft,
                    showRegionSelector,
                    selectedRegion,
                    continents,
                    collectedFlags,
                    icons: ICONS,
                    queue,
                    getRegionCount: (region) => {
                        const regionCountries = COUNTRIES.filter(c => c.continent === region);
                        const collected = regionCountries.filter(c => collectedFlags.value[c.code]);
                        return Math.round((collected.length / regionCountries.length) * 100);
                    },
                    getRegionProgress: (region) => {
                        const regionCountries = COUNTRIES.filter(c => c.continent === region);
                        const collected = regionCountries.filter(c => collectedFlags.value[c.code]);
                        return (collected.length / regionCountries.length) * 100;
                    }
                };
            }
        }).mount('#app');
    </script>
</body>
</html>